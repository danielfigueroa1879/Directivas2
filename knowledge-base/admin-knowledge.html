<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Gesti√≥n de Conocimientos OS10 Bot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .knowledge-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Panel de Login -->
    <div id="login-panel" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-500 to-purple-600">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-96">
            <h2 class="text-3xl font-bold mb-6 text-center bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                üîê Admin OS10 Bot
            </h2>
            <input type="password" id="admin-pass" placeholder="Contrase√±a" 
                   class="w-full px-4 py-3 border-2 rounded-lg mb-4 focus:border-purple-500 focus:outline-none"
                   onkeypress="if(event.key==='Enter') login()">
            <button onclick="login()" 
                    class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white font-bold py-3 rounded-lg hover:opacity-90 transition">
                Acceder al Panel
            </button>
        </div>
    </div>

    <!-- Panel Principal Admin (oculto inicialmente) -->
    <div id="admin-panel" class="hidden min-h-screen p-6">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                            ü§ñ Gesti√≥n de Conocimientos - Bot OS10
                        </h1>
                        <p class="text-gray-600 mt-2">Alimenta el conocimiento del bot con documentos PDF y textos</p>
                    </div>
                    <button onclick="logout()" class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600">
                        Cerrar Sesi√≥n
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Panel de Carga de Documentos -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-2xl font-bold mb-4 text-purple-600">üìö Cargar Documentos de Conocimiento</h2>
                        
                        <!-- √Årea de carga -->
                        <div class="border-4 border-dashed border-purple-300 rounded-xl p-8 text-center mb-6 hover:border-purple-500 transition"
                             ondrop="handleDrop(event)" ondragover="handleDragOver(event)">
                            <svg class="mx-auto h-12 w-12 text-purple-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                      d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                            </svg>
                            <p class="text-lg font-semibold text-gray-700 mb-2">Arrastra PDFs aqu√≠</p>
                            <p class="text-sm text-gray-500 mb-4">o</p>
                            <input type="file" id="file-input" accept=".pdf,.txt" multiple class="hidden" onchange="handleFiles(this.files)">
                            <button onclick="document.getElementById('file-input').click()" 
                                    class="bg-purple-500 text-white px-6 py-2 rounded-lg hover:bg-purple-600">
                                Seleccionar Archivos
                            </button>
                        </div>

                        <!-- Procesamiento de texto directo -->
                        <div class="mb-6">
                            <h3 class="font-semibold mb-2">‚úçÔ∏è Agregar Conocimiento Directo</h3>
                            <textarea id="direct-knowledge" rows="4" 
                                      placeholder="Pega aqu√≠ texto, normativas, o informaci√≥n que el bot debe aprender..."
                                      class="w-full p-3 border-2 rounded-lg focus:border-purple-500 focus:outline-none"></textarea>
                            <div class="flex gap-2 mt-2">
                                <input type="text" id="knowledge-title" placeholder="T√≠tulo del conocimiento" 
                                       class="flex-1 px-3 py-2 border rounded-lg">
                                <button onclick="addDirectKnowledge()" 
                                        class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600">
                                    Agregar al Bot
                                </button>
                            </div>
                        </div>

                        <!-- Lista de documentos procesados -->
                        <div>
                            <h3 class="font-semibold mb-3">üìÇ Base de Conocimientos Actual</h3>
                            <div id="knowledge-list" class="space-y-2 max-h-96 overflow-y-auto">
                                <!-- Los documentos se mostrar√°n aqu√≠ -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Panel de Estado y Configuraci√≥n -->
                <div class="space-y-6">
                    <!-- Estad√≠sticas -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold mb-4">üìä Estad√≠sticas del Bot</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Documentos cargados:</span>
                                <span class="font-bold text-purple-600" id="doc-count">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Palabras totales:</span>
                                <span class="font-bold text-blue-600" id="word-count">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Temas identificados:</span>
                                <span class="font-bold text-green-600" id="topic-count">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">√öltima actualizaci√≥n:</span>
                                <span class="text-sm text-gray-500" id="last-update">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Configuraci√≥n del Bot -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold mb-4">‚öôÔ∏è Configuraci√≥n del Bot</h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold mb-1">Nombre del Bot</label>
                                <input type="text" id="bot-name" value="Asistente OS10" 
                                       class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold mb-1">Personalidad</label>
                                <select id="bot-personality" class="w-full px-3 py-2 border rounded-lg">
                                    <option value="professional">Profesional y Formal</option>
                                    <option value="friendly">Amigable y Cercano</option>
                                    <option value="technical">T√©cnico y Preciso</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold mb-1">Contexto Base</label>
                                <textarea id="bot-context" rows="3" 
                                          class="w-full px-3 py-2 border rounded-lg text-sm"
                                          placeholder="Eres un experto en seguridad privada de OS10...">Eres un funcionario experto de la oficina OS10 de Seguridad Privada en Coquimbo. Tu objetivo es proporcionar informaci√≥n precisa y profesional sobre normativas, procedimientos y requisitos de seguridad privada.</textarea>
                            </div>
                            
                            <button onclick="saveConfig()" 
                                    class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600">
                                Guardar Configuraci√≥n
                            </button>
                        </div>
                    </div>

                    <!-- Acciones -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold mb-4">üöÄ Acciones</h3>
                        <div class="space-y-2">
                            <button onclick="exportKnowledge()" 
                                    class="w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600">
                                üì• Exportar Base de Conocimientos
                            </button>
                            <button onclick="deployToBot()" 
                                    class="w-full bg-purple-500 text-white py-2 rounded-lg hover:bg-purple-600">
                                üîÑ Actualizar Bot en Producci√≥n
                            </button>
                            <button onclick="testBot()" 
                                    class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600">
                                üß™ Probar Bot
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Panel de Prueba del Bot -->
            <div id="test-panel" class="hidden bg-white rounded-xl shadow-lg p-6 mt-6">
                <h3 class="text-xl font-bold mb-4">üß™ Probar Bot con Conocimientos Actuales</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block font-semibold mb-2">Pregunta de Prueba:</label>
                        <textarea id="test-query" rows="3" 
                                  placeholder="Escribe una pregunta para probar el bot..."
                                  class="w-full p-3 border rounded-lg"></textarea>
                        <button onclick="runTest()" 
                                class="mt-2 bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600">
                            Enviar Pregunta
                        </button>
                    </div>
                    <div>
                        <label class="block font-semibold mb-2">Respuesta del Bot:</label>
                        <div id="test-response" class="p-3 bg-gray-50 rounded-lg min-h-[100px]">
                            <span class="text-gray-400">La respuesta aparecer√° aqu√≠...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n de pdf.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Sistema de Gesti√≥n de Conocimientos
        class KnowledgeManager {
            constructor() {
                this.knowledge = this.loadKnowledge();
                this.config = this.loadConfig();
                this.updateStats();
            }

            // Cargar conocimientos guardados
            loadKnowledge() {
                const saved = localStorage.getItem('os10_bot_knowledge');
                return saved ? JSON.parse(saved) : [];
            }

            // Guardar conocimientos
            saveKnowledge() {
                localStorage.setItem('os10_bot_knowledge', JSON.stringify(this.knowledge));
                this.updateStats();
                this.updateUI();
            }

            // Cargar configuraci√≥n
            loadConfig() {
                const saved = localStorage.getItem('os10_bot_config');
                return saved ? JSON.parse(saved) : {
                    botName: 'Asistente OS10',
                    personality: 'professional',
                    context: 'Eres un funcionario experto de la oficina OS10 de Seguridad Privada en Coquimbo.'
                };
            }

            // Procesar PDF
            async processPDF(file) {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                let fullText = '';
                
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + '\n';
                }
                
                return this.processAndStructureText(fullText, file.name);
            }

            // Procesar y estructurar el texto
            processAndStructureText(text, title) {
                // Limpiar y normalizar el texto
                const cleanText = text
                    .replace(/\s+/g, ' ')
                    .replace(/\n{3,}/g, '\n\n')
                    .trim();

                // Extraer secciones importantes
                const sections = this.extractSections(cleanText);
                
                // Extraer entidades importantes (art√≠culos, decretos, etc.)
                const entities = this.extractEntities(cleanText);
                
                // Generar resumen
                const summary = this.generateSummary(cleanText);
                
                // Identificar temas principales
                const topics = this.identifyTopics(cleanText);

                return {
                    id: Date.now().toString(),
                    title: title,
                    fullText: cleanText,
                    sections: sections,
                    entities: entities,
                    summary: summary,
                    topics: topics,
                    wordCount: cleanText.split(/\s+/).length,
                    addedAt: new Date().toISOString()
                };
            }

            // Extraer secciones del texto
            extractSections(text) {
                const sections = [];
                
                // Buscar t√≠tulos y subt√≠tulos
                const patterns = [
                    /(?:T√çTULO|CAPITULO|ART√çCULO|SECCI√ìN)\s+[IVX\d]+[:\s.-]*/gi,
                    /(?:\d+\.[-\s]*)([A-Z][^.!?]*[.!?])/g,
                    /^[A-Z\s]{5,}$/gm
                ];
                
                patterns.forEach(pattern => {
                    const matches = text.match(pattern);
                    if (matches) {
                        matches.forEach(match => {
                            const startIndex = text.indexOf(match);
                            const endIndex = startIndex + Math.min(500, text.length - startIndex);
                            sections.push({
                                title: match.substring(0, 100),
                                content: text.substring(startIndex, endIndex)
                            });
                        });
                    }
                });
                
                return sections;
            }

            // Extraer entidades importantes
            extractEntities(text) {
                const entities = {
                    articles: [],
                    decrees: [],
                    laws: [],
                    dates: [],
                    amounts: []
                };
                
                // Art√≠culos
                const articlePattern = /(?:art√≠culo|art\.?)\s*(\d+)/gi;
                let match;
                while ((match = articlePattern.exec(text)) !== null) {
                    entities.articles.push(match[1]);
                }
                
                // Decretos
                const decreePattern = /(?:decreto|DS|D\.S\.?)\s*(?:N¬∞|N¬∫|#)?\s*(\d+)/gi;
                while ((match = decreePattern.exec(text)) !== null) {
                    entities.decrees.push(match[1]);
                }
                
                // Leyes
                const lawPattern = /(?:ley|L\.)\s*(?:N¬∞|N¬∫|#)?\s*(\d+\.?\d*)/gi;
                while ((match = lawPattern.exec(text)) !== null) {
                    entities.laws.push(match[1]);
                }
                
                // Fechas
                const datePattern = /\d{1,2}[\/-]\d{1,2}[\/-]\d{2,4}/g;
                entities.dates = [...new Set(text.match(datePattern) || [])];
                
                // Montos
                const amountPattern = /(?:\$|UTM|UF)\s*[\d,.]+/gi;
                entities.amounts = [...new Set(text.match(amountPattern) || [])];
                
                return entities;
            }

            // Generar resumen
            generateSummary(text) {
                const sentences = text.match(/[^.!?]+[.!?]/g) || [];
                const importantSentences = sentences.filter(s => 
                    /(?:debe|obligatorio|requisito|prohibido|sanci√≥n|multa|plazo)/i.test(s)
                );
                
                return importantSentences.slice(0, 3).join(' ') || sentences.slice(0, 3).join(' ');
            }

            // Identificar temas principales
            identifyTopics(text) {
                const topics = [];
                const topicKeywords = {
                    'Vigilantes Privados': /vigilante.*privad/gi,
                    'Guardias de Seguridad': /guardia.*seguridad/gi,
                    'Credenciales': /credencial/gi,
                    'Capacitaci√≥n': /capacitaci√≥n|curso|formaci√≥n/gi,
                    'Directiva de Funcionamiento': /directiva.*funcionamiento/gi,
                    'Sanciones': /sanci√≥n|multa|infracci√≥n/gi,
                    'Armas': /arma|armamento|porte/gi,
                    'Uniformes': /uniforme|vestimenta|tenida/gi,
                    'Empresas de Seguridad': /empresa.*seguridad/gi,
                    'Transporte de Valores': /transporte.*valores/gi
                };
                
                for (const [topic, pattern] of Object.entries(topicKeywords)) {
                    if (pattern.test(text)) {
                        topics.push(topic);
                    }
                }
                
                return topics;
            }

            // Agregar conocimiento directo
            addDirectKnowledge(title, text) {
                const knowledge = this.processAndStructureText(text, title);
                this.knowledge.push(knowledge);
                this.saveKnowledge();
                return knowledge;
            }

            // Eliminar conocimiento
            removeKnowledge(id) {
                this.knowledge = this.knowledge.filter(k => k.id !== id);
                this.saveKnowledge();
            }

            // Actualizar estad√≠sticas
            updateStats() {
                document.getElementById('doc-count').textContent = this.knowledge.length;
                
                const totalWords = this.knowledge.reduce((sum, k) => sum + k.wordCount, 0);
                document.getElementById('word-count').textContent = totalWords.toLocaleString();
                
                const allTopics = new Set();
                this.knowledge.forEach(k => k.topics.forEach(t => allTopics.add(t)));
                document.getElementById('topic-count').textContent = allTopics.size;
                
                if (this.knowledge.length > 0) {
                    const lastDoc = this.knowledge[this.knowledge.length - 1];
                    document.getElementById('last-update').textContent = 
                        new Date(lastDoc.addedAt).toLocaleString('es-CL');
                }
            }

            // Actualizar UI
            updateUI() {
                const list = document.getElementById('knowledge-list');
                list.innerHTML = this.knowledge.map(k => `
                    <div class="bg-gradient-to-r from-purple-500 to-blue-500 text-white p-4 rounded-lg">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h4 class="font-bold">${k.title}</h4>
                                <p class="text-sm opacity-90 mt-1">${k.summary.substring(0, 100)}...</p>
                                <div class="flex gap-2 mt-2">
                                    ${k.topics.slice(0, 3).map(t => 
                                        `<span class="bg-white/20 px-2 py-1 rounded text-xs">${t}</span>`
                                    ).join('')}
                                </div>
                                <p class="text-xs opacity-75 mt-2">
                                    ${k.wordCount} palabras | ${new Date(k.addedAt).toLocaleDateString('es-CL')}
                                </p>
                            </div>
                            <button onclick="km.removeKnowledge('${k.id}')" 
                                    class="ml-4 bg-red-500 hover:bg-red-600 px-3 py-1 rounded text-sm">
                                Eliminar
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            // Exportar para el bot
            exportForBot() {
                return {
                    config: this.config,
                    knowledge: this.knowledge.map(k => ({
                        title: k.title,
                        content: k.fullText,
                        sections: k.sections,
                        entities: k.entities,
                        topics: k.topics
                    })),
                    timestamp: new Date().toISOString()
                };
            }
        }

        // Instancia global
        const km = new KnowledgeManager();

        // Funciones de autenticaci√≥n
        function login() {
            const password = document.getElementById('admin-pass').value;
            // ‚ö†Ô∏è IMPORTANTE: CAMBIA ESTA CONTRASE√ëA ‚ö†Ô∏è
            if (password === 'OS10Admin2024') {
                document.getElementById('login-panel').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
                km.updateUI();
            } else {
                alert('Contrase√±a incorrecta');
            }
        }

        function logout() {
            document.getElementById('admin-panel').classList.add('hidden');
            document.getElementById('login-panel').classList.remove('hidden');
            document.getElementById('admin-pass').value = '';
        }

        // Manejo de archivos
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('border-purple-500', 'bg-purple-50');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('border-purple-500', 'bg-purple-50');
            handleFiles(e.dataTransfer.files);
        }

        async function handleFiles(files) {
            for (const file of files) {
                if (file.type === 'application/pdf') {
                    const knowledge = await km.processPDF(file);
                    km.knowledge.push(knowledge);
                    alert(`‚úÖ PDF "${file.name}" procesado exitosamente`);
                } else if (file.type === 'text/plain') {
                    const text = await file.text();
                    const knowledge = km.processAndStructureText(text, file.name);
                    km.knowledge.push(knowledge);
                    alert(`‚úÖ Archivo de texto "${file.name}" procesado exitosamente`);
                }
            }
            km.saveKnowledge();
        }

        // Agregar conocimiento directo
        function addDirectKnowledge() {
            const title = document.getElementById('knowledge-title').value;
            const text = document.getElementById('direct-knowledge').value;
            
            if (!title || !text) {
                alert('Por favor ingresa t√≠tulo y contenido');
                return;
            }
            
            km.addDirectKnowledge(title, text);
            document.getElementById('knowledge-title').value = '';
            document.getElementById('direct-knowledge').value = '';
            alert('‚úÖ Conocimiento agregado exitosamente');
        }

        // Guardar configuraci√≥n
        function saveConfig() {
            km.config.botName = document.getElementById('bot-name').value;
            km.config.personality = document.getElementById('bot-personality').value;
            km.config.context = document.getElementById('bot-context').value;
            
            localStorage.setItem('os10_bot_config', JSON.stringify(km.config));
            alert('‚úÖ Configuraci√≥n guardada');
        }

        // Exportar conocimientos
        function exportKnowledge() {
            const data = km.exportForBot();
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `os10_knowledge_${Date.now()}.json`;
            a.click();
            alert('üì• Base de conocimientos exportada');
        }

        // Actualizar bot en producci√≥n
        function deployToBot() {
            const data = km.exportForBot();
            localStorage.setItem('os10_bot_production_knowledge', JSON.stringify(data));
            alert('‚úÖ Base de conocimientos actualizada en el bot de producci√≥n\n\nLos usuarios ya pueden acceder a la informaci√≥n actualizada.');
        }

        // Probar bot
        function testBot() {
            document.getElementById('test-panel').classList.toggle('hidden');
        }

        // Ejecutar prueba
        async function runTest() {
            const query = document.getElementById('test-query').value;
            if (!query) return;
            
            const response = searchKnowledge(query);
            document.getElementById('test-response').innerHTML = `
                <div class="text-gray-800">${response}</div>
            `;
        }

        // Funci√≥n de b√∫squeda en conocimientos
        function searchKnowledge(query) {
            const queryLower = query.toLowerCase();
            const results = [];
            
            km.knowledge.forEach(doc => {
                // Buscar en el texto completo
                if (doc.fullText.toLowerCase().includes(queryLower)) {
                    // Encontrar la secci√≥n m√°s relevante
                    const relevantSection = doc.sections.find(s => 
                        s.content.toLowerCase().includes(queryLower)
                    );
                    
                    if (relevantSection) {
                        results.push({
                            source: doc.title,
                            content: relevantSection.content,
                            relevance: 10
                        });
                    }
                }
                
                // Buscar en entidades
                Object.entries(doc.entities).forEach(([type, values]) => {
                    values.forEach(value => {
                        if (queryLower.includes(value.toLowerCase())) {
                            results.push({
                                source: doc.title,
                                content: `Informaci√≥n sobre ${type}: ${value}`,
                                relevance: 5
                            });
                        }
                    });
                });
            });
            
            if (results.length > 0) {
                const best = results.sort((a, b) => b.relevance - a.relevance)[0];
                return `<strong>Seg√∫n ${best.source}:</strong><br><br>${best.content.substring(0, 500)}...`;
            }
            
            return "No encontr√© informaci√≥n espec√≠fica sobre esa consulta en la base de conocimientos actual.";
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Sistema de gesti√≥n de conocimientos iniciado');
            console.log('Documentos en base de datos:', km.knowledge.length);
        });
    </script>
</body>
</html><!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Gesti√≥n de Conocimientos OS10 Bot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .knowledge-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Panel de Login -->
    <div id="login-panel" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-500 to-purple-600">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-96">
            <h2 class="text-3xl font-bold mb-6 text-center bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                üîê Admin OS10 Bot
            </h2>
            <input type="password" id="admin-pass" placeholder="Contrase√±a" 
                   class="w-full px-4 py-3 border-2 rounded-lg mb-4 focus:border-purple-500 focus:outline-none"
                   onkeypress="if(event.key==='Enter') login()">
            <button onclick="login()" 
                    class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white font-bold py-3 rounded-lg hover:opacity-90 transition">
                Acceder al Panel
            </button>
        </div>
    </div>

    <!-- Panel Principal Admin (oculto inicialmente) -->
    <div id="admin-panel" class="hidden min-h-screen p-6">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                            ü§ñ Gesti√≥n de Conocimientos - Bot OS10
                        </h1>
                        <p class="text-gray-600 mt-2">Alimenta el conocimiento del bot con documentos PDF y textos</p>
                    </div>
                    <button onclick="logout()" class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600">
                        Cerrar Sesi√≥n
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Panel de Carga de Documentos -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-2xl font-bold mb-4 text-purple-600">üìö Cargar Documentos de Conocimiento</h2>
                        
                        <!-- √Årea de carga -->
                        <div class="border-4 border-dashed border-purple-300 rounded-xl p-8 text-center mb-6 hover:border-purple-500 transition"
                             ondrop="handleDrop(event)" ondragover="handleDragOver(event)">
                            <svg class="mx-auto h-12 w-12 text-purple-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                      d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                            </svg>
                            <p class="text-lg font-semibold text-gray-700 mb-2">Arrastra PDFs aqu√≠</p>
                            <p class="text-sm text-gray-500 mb-4">o</p>
                            <input type="file" id="file-input" accept=".pdf,.txt" multiple class="hidden" onchange="handleFiles(this.files)">
                            <button onclick="document.getElementById('file-input').click()" 
                                    class="bg-purple-500 text-white px-6 py-2 rounded-lg hover:bg-purple-600">
                                Seleccionar Archivos
                            </button>
                        </div>

                        <!-- Procesamiento de texto directo -->
                        <div class="mb-6">
                            <h3 class="font-semibold mb-2">‚úçÔ∏è Agregar Conocimiento Directo</h3>
                            <textarea id="direct-knowledge" rows="4" 
                                      placeholder="Pega aqu√≠ texto, normativas, o informaci√≥n que el bot debe aprender..."
                                      class="w-full p-3 border-2 rounded-lg focus:border-purple-500 focus:outline-none"></textarea>
                            <div class="flex gap-2 mt-2">
                                <input type="text" id="knowledge-title" placeholder="T√≠tulo del conocimiento" 
                                       class="flex-1 px-3 py-2 border rounded-lg">
                                <button onclick="addDirectKnowledge()" 
                                        class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600">
                                    Agregar al Bot
                                </button>
                            </div>
                        </div>

                        <!-- Lista de documentos procesados -->
                        <div>
                            <h3 class="font-semibold mb-3">üìÇ Base de Conocimientos Actual</h3>
                            <div id="knowledge-list" class="space-y-2 max-h-96 overflow-y-auto">
                                <!-- Los documentos se mostrar√°n aqu√≠ -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Panel de Estado y Configuraci√≥n -->
                <div class="space-y-6">
                    <!-- Estad√≠sticas -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold mb-4">üìä Estad√≠sticas del Bot</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Documentos cargados:</span>
                                <span class="font-bold text-purple-600" id="doc-count">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Palabras totales:</span>
                                <span class="font-bold text-blue-600" id="word-count">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Temas identificados:</span>
                                <span class="font-bold text-green-600" id="topic-count">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">√öltima actualizaci√≥n:</span>
                                <span class="text-sm text-gray-500" id="last-update">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Configuraci√≥n del Bot -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold mb-4">‚öôÔ∏è Configuraci√≥n del Bot</h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold mb-1">Nombre del Bot</label>
                                <input type="text" id="bot-name" value="Asistente OS10" 
                                       class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold mb-1">Personalidad</label>
                                <select id="bot-personality" class="w-full px-3 py-2 border rounded-lg">
                                    <option value="professional">Profesional y Formal</option>
                                    <option value="friendly">Amigable y Cercano</option>
                                    <option value="technical">T√©cnico y Preciso</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold mb-1">Contexto Base</label>
                                <textarea id="bot-context" rows="3" 
                                          class="w-full px-3 py-2 border rounded-lg text-sm"
                                          placeholder="Eres un experto en seguridad privada de OS10...">Eres un funcionario experto de la oficina OS10 de Seguridad Privada en Coquimbo. Tu objetivo es proporcionar informaci√≥n precisa y profesional sobre normativas, procedimientos y requisitos de seguridad privada.</textarea>
                            </div>
                            
                            <button onclick="saveConfig()" 
                                    class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600">
                                Guardar Configuraci√≥n
                            </button>
                        </div>
                    </div>

                    <!-- Acciones -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold mb-4">üöÄ Acciones</h3>
                        <div class="space-y-2">
                            <button onclick="exportKnowledge()" 
                                    class="w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600">
                                üì• Exportar Base de Conocimientos
                            </button>
                            <button onclick="deployToBot()" 
                                    class="w-full bg-purple-500 text-white py-2 rounded-lg hover:bg-purple-600">
                                üîÑ Actualizar Bot en Producci√≥n
                            </button>
                            <button onclick="testBot()" 
                                    class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600">
                                üß™ Probar Bot
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Panel de Prueba del Bot -->
            <div id="test-panel" class="hidden bg-white rounded-xl shadow-lg p-6 mt-6">
                <h3 class="text-xl font-bold mb-4">üß™ Probar Bot con Conocimientos Actuales</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block font-semibold mb-2">Pregunta de Prueba:</label>
                        <textarea id="test-query" rows="3" 
                                  placeholder="Escribe una pregunta para probar el bot..."
                                  class="w-full p-3 border rounded-lg"></textarea>
                        <button onclick="runTest()" 
                                class="mt-2 bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600">
                            Enviar Pregunta
                        </button>
                    </div>
                    <div>
                        <label class="block font-semibold mb-2">Respuesta del Bot:</label>
                        <div id="test-response" class="p-3 bg-gray-50 rounded-lg min-h-[100px]">
                            <span class="text-gray-400">La respuesta aparecer√° aqu√≠...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n de pdf.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Sistema de Gesti√≥n de Conocimientos
        class KnowledgeManager {
            constructor() {
                this.knowledge = this.loadKnowledge();
                this.config = this.loadConfig();
                this.updateStats();
            }

            // Cargar conocimientos guardados
            loadKnowledge() {
                const saved = localStorage.getItem('os10_bot_knowledge');
                return saved ? JSON.parse(saved) : [];
            }

            // Guardar conocimientos
            saveKnowledge() {
                localStorage.setItem('os10_bot_knowledge', JSON.stringify(this.knowledge));
                this.updateStats();
                this.updateUI();
            }

            // Cargar configuraci√≥n
            loadConfig() {
                const saved = localStorage.getItem('os10_bot_config');
                return saved ? JSON.parse(saved) : {
                    botName: 'Asistente OS10',
                    personality: 'professional',
                    context: 'Eres un funcionario experto de la oficina OS10 de Seguridad Privada en Coquimbo.'
                };
            }

            // Procesar PDF
            async processPDF(file) {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                let fullText = '';
                
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + '\n';
                }
                
                return this.processAndStructureText(fullText, file.name);
            }

            // Procesar y estructurar el texto
            processAndStructureText(text, title) {
                // Limpiar y normalizar el texto
                const cleanText = text
                    .replace(/\s+/g, ' ')
                    .replace(/\n{3,}/g, '\n\n')
                    .trim();

                // Extraer secciones importantes
                const sections = this.extractSections(cleanText);
                
                // Extraer entidades importantes (art√≠culos, decretos, etc.)
                const entities = this.extractEntities(cleanText);
                
                // Generar resumen
                const summary = this.generateSummary(cleanText);
                
                // Identificar temas principales
                const topics = this.identifyTopics(cleanText);

                return {
                    id: Date.now().toString(),
                    title: title,
                    fullText: cleanText,
                    sections: sections,
                    entities: entities,
                    summary: summary,
                    topics: topics,
                    wordCount: cleanText.split(/\s+/).length,
                    addedAt: new Date().toISOString()
                };
            }

            // Extraer secciones del texto
            extractSections(text) {
                const sections = [];
                
                // Buscar t√≠tulos y subt√≠tulos
                const patterns = [
                    /(?:T√çTULO|CAPITULO|ART√çCULO|SECCI√ìN)\s+[IVX\d]+[:\s.-]*/gi,
                    /(?:\d+\.[-\s]*)([A-Z][^.!?]*[.!?])/g,
                    /^[A-Z\s]{5,}$/gm
                ];
                
                patterns.forEach(pattern => {
                    const matches = text.match(pattern);
                    if (matches) {
                        matches.forEach(match => {
                            const startIndex = text.indexOf(match);
                            const endIndex = startIndex + Math.min(500, text.length - startIndex);
                            sections.push({
                                title: match.substring(0, 100),
                                content: text.substring(startIndex, endIndex)
                            });
                        });
                    }
                });
                
                return sections;
            }

            // Extraer entidades importantes
            extractEntities(text) {
                const entities = {
                    articles: [],
                    decrees: [],
                    laws: [],
                    dates: [],
                    amounts: []
                };
                
                // Art√≠culos
                const articlePattern = /(?:art√≠culo|art\.?)\s*(\d+)/gi;
                let match;
                while ((match = articlePattern.exec(text)) !== null) {
                    entities.articles.push(match[1]);
                }
                
                // Decretos
                const decreePattern = /(?:decreto|DS|D\.S\.?)\s*(?:N¬∞|N¬∫|#)?\s*(\d+)/gi;
                while ((match = decreePattern.exec(text)) !== null) {
                    entities.decrees.push(match[1]);
                }
                
                // Leyes
                const lawPattern = /(?:ley|L\.)\s*(?:N¬∞|N¬∫|#)?\s*(\d+\.?\d*)/gi;
                while ((match = lawPattern.exec(text)) !== null) {
                    entities.laws.push(match[1]);
                }
                
                // Fechas
                const datePattern = /\d{1,2}[\/-]\d{1,2}[\/-]\d{2,4}/g;
                entities.dates = [...new Set(text.match(datePattern) || [])];
                
                // Montos
                const amountPattern = /(?:\$|UTM|UF)\s*[\d,.]+/gi;
                entities.amounts = [...new Set(text.match(amountPattern) || [])];
                
                return entities;
            }

            // Generar resumen
            generateSummary(text) {
                const sentences = text.match(/[^.!?]+[.!?]/g) || [];
                const importantSentences = sentences.filter(s => 
                    /(?:debe|obligatorio|requisito|prohibido|sanci√≥n|multa|plazo)/i.test(s)
                );
                
                return importantSentences.slice(0, 3).join(' ') || sentences.slice(0, 3).join(' ');
            }

            // Identificar temas principales
            identifyTopics(text) {
                const topics = [];
                const topicKeywords = {
                    'Vigilantes Privados': /vigilante.*privad/gi,
                    'Guardias de Seguridad': /guardia.*seguridad/gi,
                    'Credenciales': /credencial/gi,
                    'Capacitaci√≥n': /capacitaci√≥n|curso|formaci√≥n/gi,
                    'Directiva de Funcionamiento': /directiva.*funcionamiento/gi,
                    'Sanciones': /sanci√≥n|multa|infracci√≥n/gi,
                    'Armas': /arma|armamento|porte/gi,
                    'Uniformes': /uniforme|vestimenta|tenida/gi,
                    'Empresas de Seguridad': /empresa.*seguridad/gi,
                    'Transporte de Valores': /transporte.*valores/gi
                };
                
                for (const [topic, pattern] of Object.entries(topicKeywords)) {
                    if (pattern.test(text)) {
                        topics.push(topic);
                    }
                }
                
                return topics;
            }

            // Agregar conocimiento directo
            addDirectKnowledge(title, text) {
                const knowledge = this.processAndStructureText(text, title);
                this.knowledge.push(knowledge);
                this.saveKnowledge();
                return knowledge;
            }

            // Eliminar conocimiento
            removeKnowledge(id) {
                this.knowledge = this.knowledge.filter(k => k.id !== id);
                this.saveKnowledge();
            }

            // Actualizar estad√≠sticas
            updateStats() {
                document.getElementById('doc-count').textContent = this.knowledge.length;
                
                const totalWords = this.knowledge.reduce((sum, k) => sum + k.wordCount, 0);
                document.getElementById('word-count').textContent = totalWords.toLocaleString();
                
                const allTopics = new Set();
                this.knowledge.forEach(k => k.topics.forEach(t => allTopics.add(t)));
                document.getElementById('topic-count').textContent = allTopics.size;
                
                if (this.knowledge.length > 0) {
                    const lastDoc = this.knowledge[this.knowledge.length - 1];
                    document.getElementById('last-update').textContent = 
                        new Date(lastDoc.addedAt).toLocaleString('es-CL');
                }
            }

            // Actualizar UI
            updateUI() {
                const list = document.getElementById('knowledge-list');
                list.innerHTML = this.knowledge.map(k => `
                    <div class="bg-gradient-to-r from-purple-500 to-blue-500 text-white p-4 rounded-lg">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h4 class="font-bold">${k.title}</h4>
                                <p class="text-sm opacity-90 mt-1">${k.summary.substring(0, 100)}...</p>
                                <div class="flex gap-2 mt-2">
                                    ${k.topics.slice(0, 3).map(t => 
                                        `<span class="bg-white/20 px-2 py-1 rounded text-xs">${t}</span>`
                                    ).join('')}
                                </div>
                                <p class="text-xs opacity-75 mt-2">
                                    ${k.wordCount} palabras | ${new Date(k.addedAt).toLocaleDateString('es-CL')}
                                </p>
                            </div>
                            <button onclick="km.removeKnowledge('${k.id}')" 
                                    class="ml-4 bg-red-500 hover:bg-red-600 px-3 py-1 rounded text-sm">
                                Eliminar
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            // Exportar para el bot
            exportForBot() {
                return {
                    config: this.config,
                    knowledge: this.knowledge.map(k => ({
                        title: k.title,
                        content: k.fullText,
                        sections: k.sections,
                        entities: k.entities,
                        topics: k.topics
                    })),
                    timestamp: new Date().toISOString()
                };
            }
        }

        // Instancia global
        const km = new KnowledgeManager();

        // Funciones de autenticaci√≥n
        function login() {
            const password = document.getElementById('admin-pass').value;
            // ‚ö†Ô∏è IMPORTANTE: CAMBIA ESTA CONTRASE√ëA ‚ö†Ô∏è
            if (password === 'OS10Admin2024') {
                document.getElementById('login-panel').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
                km.updateUI();
            } else {
                alert('Contrase√±a incorrecta');
            }
        }

        function logout() {
            document.getElementById('admin-panel').classList.add('hidden');
            document.getElementById('login-panel').classList.remove('hidden');
            document.getElementById('admin-pass').value = '';
        }

        // Manejo de archivos
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('border-purple-500', 'bg-purple-50');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('border-purple-500', 'bg-purple-50');
            handleFiles(e.dataTransfer.files);
        }

        async function handleFiles(files) {
            for (const file of files) {
                if (file.type === 'application/pdf') {
                    const knowledge = await km.processPDF(file);
                    km.knowledge.push(knowledge);
                    alert(`‚úÖ PDF "${file.name}" procesado exitosamente`);
                } else if (file.type === 'text/plain') {
                    const text = await file.text();
                    const knowledge = km.processAndStructureText(text, file.name);
                    km.knowledge.push(knowledge);
                    alert(`‚úÖ Archivo de texto "${file.name}" procesado exitosamente`);
                }
            }
            km.saveKnowledge();
        }

        // Agregar conocimiento directo
        function addDirectKnowledge() {
            const title = document.getElementById('knowledge-title').value;
            const text = document.getElementById('direct-knowledge').value;
            
            if (!title || !text) {
                alert('Por favor ingresa t√≠tulo y contenido');
                return;
            }
            
            km.addDirectKnowledge(title, text);
            document.getElementById('knowledge-title').value = '';
            document.getElementById('direct-knowledge').value = '';
            alert('‚úÖ Conocimiento agregado exitosamente');
        }

        // Guardar configuraci√≥n
        function saveConfig() {
            km.config.botName = document.getElementById('bot-name').value;
            km.config.personality = document.getElementById('bot-personality').value;
            km.config.context = document.getElementById('bot-context').value;
            
            localStorage.setItem('os10_bot_config', JSON.stringify(km.config));
            alert('‚úÖ Configuraci√≥n guardada');
        }

        // Exportar conocimientos
        function exportKnowledge() {
            const data = km.exportForBot();
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `os10_knowledge_${Date.now()}.json`;
            a.click();
            alert('üì• Base de conocimientos exportada');
        }

        // Actualizar bot en producci√≥n
        function deployToBot() {
            const data = km.exportForBot();
            localStorage.setItem('os10_bot_production_knowledge', JSON.stringify(data));
            alert('‚úÖ Base de conocimientos actualizada en el bot de producci√≥n\n\nLos usuarios ya pueden acceder a la informaci√≥n actualizada.');
        }

        // Probar bot
        function testBot() {
            document.getElementById('test-panel').classList.toggle('hidden');
        }

        // Ejecutar prueba
        async function runTest() {
            const query = document.getElementById('test-query').value;
            if (!query) return;
            
            const response = searchKnowledge(query);
            document.getElementById('test-response').innerHTML = `
                <div class="text-gray-800">${response}</div>
            `;
        }

        // Funci√≥n de b√∫squeda en conocimientos
        function searchKnowledge(query) {
            const queryLower = query.toLowerCase();
            const results = [];
            
            km.knowledge.forEach(doc => {
                // Buscar en el texto completo
                if (doc.fullText.toLowerCase().includes(queryLower)) {
                    // Encontrar la secci√≥n m√°s relevante
                    const relevantSection = doc.sections.find(s => 
                        s.content.toLowerCase().includes(queryLower)
                    );
                    
                    if (relevantSection) {
                        results.push({
                            source: doc.title,
                            content: relevantSection.content,
                            relevance: 10
                        });
                    }
                }
                
                // Buscar en entidades
                Object.entries(doc.entities).forEach(([type, values]) => {
                    values.forEach(value => {
                        if (queryLower.includes(value.toLowerCase())) {
                            results.push({
                                source: doc.title,
                                content: `Informaci√≥n sobre ${type}: ${value}`,
                                relevance: 5
                            });
                        }
                    });
                });
            });
            
            if (results.length > 0) {
                const best = results.sort((a, b) => b.relevance - a.relevance)[0];
                return `<strong>Seg√∫n ${best.source}:</strong><br><br>${best.content.substring(0, 500)}...`;
            }
            
            return "No encontr√© informaci√≥n espec√≠fica sobre esa consulta en la base de conocimientos actual.";
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Sistema de gesti√≥n de conocimientos iniciado');
            console.log('Documentos en base de datos:', km.knowledge.length);
        });
    </script>
</body>
</html>
