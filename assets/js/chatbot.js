/**
 * chatbot.js
 * * This module handles all the functionality for the floating chatbot widget.
 * It manages the UI, state, and communication with the Gemini API.
 * It now includes a system for predefined responses and Markdown to HTML conversion.
 */

// --- DOM Element Selection ---
const chatPopup = document.getElementById('chat-popup');
const chatToggleButton = document.getElementById('chat-toggle-button');
const chatMessages = document.getElementById('chat-messages');
const userInput = document.getElementById('user-input');
const sendButton = document.getElementById('send-button');
const chatBackdrop = document.getElementById('chat-backdrop');
const chatWidgetContainer = document.getElementById('chat-widget-container');
const internalCloseBtn = document.getElementById('chat-close-btn-internal');


// --- Predefined Responses ---
const predefinedResponses = {
    'rule_4': { keywords: ["guias","guia","componentes del sistema","componentes"], response: '*ESCRIBA EL NOMBRE DEL COMPONENTE DEL SISTEMA Y SE DESCARGARA UNA GUIA, PARA QUE PUEDA REALIZAR SU TRAMITE*ğŸ‘®ğŸ»â€â™‚ï¸ \n â¬‡ï¸\n*1.-* VIGILANTE PRIVADO\n*2.-* GUARDIA DE SEGURIDAD\n*3.-* JEFE DE SEGURIDAD \n*4.-* ENCARGADO DE SEGURIDAD\n*5.-* SUPERVISOR\n*6.-* ASESOR \n*7.-* CAPACITADOR\n*8.-* TÃ‰CNICO \n*9.-* OPERADOR DE CAJEROS \n*10.-* INSTALADOR TÃ‰C. DE SEGURIDAD\n*11.-* OPERADOR CCTV.\n*12.-* EMPRESAS' },
    'rule_5': { keywords: ["guardia de seguridad","guardia","guardia seguridad"], response: 'ğŸ¤– ğŸ§™ğŸ»â€â™‚ï¸ Ok... en este link encontrarÃ¡ la guÃ­a de *GUARDIA DE SEGURIDAD* la puede descargar: https://www.zosepcar.cl/content/OS10/TRAM_guardia_de_seguridad.pdf' },
    'rule_6': { keywords: ["jefe de seguridad"], response: 'OK..en este link encontrarÃ¡ la guÃ­a de *JEFE DE SEGURIDAD* la puede descargar: https://www.zosepcar.cl/content/OS10/TRAM_jefe_de_seguridad.pdf' },
    'rule_7': { keywords: ["supervisor","acreditaciÃ³n supervisor","supervisor seguridad","para supervisor","acreditar un supervisor","supervisores","acreditar supervisores"], response: 'ğŸ¤–. *SUPERVISOR* \n1.- *GUIA*\nhttps://www.zosepcar.cl/content/OS10/TRAM_supervisor.pdf\n2.- *CREDENCIAL*\nhttps://os10.short.gy/Sup' },
    'rule_8': { keywords: ["*encargado de seguridad*","*encargado*"], response: 'ğŸ¤– *ENCARGADO DE SEGURIDAD*\n*CREDENCIAL:*\nhttps://bit.ly/3H6pIOu\n*GUIA:*\nhttps://www.zosepcar.cl/content/OS10/TRAM_encargado_de_seguridad.pdf' },
    'rule_9': { keywords: ["capacitador"], response: 'ğŸ¤– *CAPACITADOR*\nhttps://www.zosepcar.cl/content/OS10/TRAM_capacitador.pdf' },
    'rule_10': { keywords: ["tecnico"], response: '*TÃ‰CNICO* https://www.zosepcar.cl/content/OS10/TRAM_tecnico.pdf' },
    'rule_11': { keywords: ["asesor"], response: 'ğŸ¤– *ASESOR*\n**GUÃA:* \nhttps://www.zosepcar.cl/content/OS10/TRAM_asesor.pdf' },
    'rule_12': { keywords: ["*instalador tecnico","*tÃ©cnico*","instalador*"], response: '*INSTALADOR TÃ‰CNICO*\n https://www.zosepcar.cl/content/OS10/TRAM_instalador_tecnico.pdf' },
    'rule_13': { keywords: ["operador de cajeros"], response: '*OPERADOR DE CAJEROS AUTOMÃTICOS* \nhttps://www.zosepcar.cl/content/OS10/TRAM_operador_cajeros.pdf' },
    'rule_14': { keywords: ["*operador cctv","cctv*"], response: 'ğŸ¤– *OPERADOR CCTV*\n*GUÃA:* https://www.zosepcar.cl/content/OS10/TRAM_operador_cctv.pdf' },
    'rule_15': { keywords: ["manuales"], response: 'ğŸ¤– â¬‡ï¸ *ESCRIBE UNA OPCIÃ“N* ğŸ‘®ğŸ»â€â™‚ï¸ğŸš¦\n*1M.-* MANUAL DE FUNCIONAMIENTO\n*2M.-* MANUAL DE CAPACITACIÃ“N \n*3M.-* MANUAL DE ORGANIZACIÃ“N' },
    'rule_16': { keywords: ["empresas","empresa"], response: '*EMPRESAS* https://www.zosepcar.cl/content/OS10/TRAM_empresas.pdf' },
    'rule_17': { keywords: ["1m"], response: '*MANUAL DE FUNCIONAMIENTO* https://www.zosepcar.cl/content/OS10/manual_funcionamiento.pdf' },
    'rule_18': { keywords: ["3m"], response: '*MANUAL DE ORGANIZACIÃ“N*\nhttps://www.zosepcar.cl/content/OS10/manual_organizacion.pdf' },
    'rule_19': { keywords: ["2m"], response: '*MANUAL DE CAPACITACIÃ“N*\nhttps://www.zosepcar.cl/content/OS10/manual_capacitacion.pdf' },
    'rule_20': { keywords: ["leyes"], response: '*ESCRIBE UN NUMERO LEY O DECRETO*.\n ğŸš¦. â¬‡ï¸ \n \nDECTO. *261* DEL 31.0 un7.2020\nDECTO. *298* DEL 17.09.2019\n DECTO. *123* DEL 05.04.2019\nDECTO. *1045* DEL 12.09.2018\nDECTO. *867* DEL 12.09.2017\nDECTO. *1814* DEL 10.11.2014\nDECTO. *222* DEL 30.10.2014\nDECTO. *1122* DEL 19.10.1994\nDECTO. *41* DEL 05.03.1996\nDECTO. *1772* DEL 26.01.1995\nDECTO. *1773* DEL 14.11.1994\nDECTO. *93* DEL 21.10.1985\nD. LEY. *3607* DEL 08.01.1981\nLEY *19303* DEL 13.04.1994\nResol. *253* DEL 29.10.2013\nResol. *59* DEL 30.09.2014\nResol. *32* DEL 31.01.2024\nResol. *80* DEL 20.03.2024\nLEY. *21659* DEL 21.03.2024' },
    'rule_21': { keywords: ["261"], response: '*DECRETO NRO 261*. \n\n\nhttps://www.zosepcar.cl/content/OS10/Decreto-261.pdf' },
    'rule_22': { keywords: ["298"], response: '*DECRETO 298*. https://www.bcn.cl/leychile/navegar?idNorma=1136545&idParte=10054790&idVersion=2019-09-17' },
    'rule_23': { keywords: ["123"], response: '*DECRETO 123*. https://www.bcn.cl/leychile/navegar?idNorma=1130300' },
    'rule_24': { keywords: ["1045"], response: '*DECRETO 1045*. https://www.bcn.cl/leychile/navegar?idNorma=1122982&idParte=9948603&idVersion=2018-09-12' },
    'rule_25': { keywords: ["867"], response: '*DECRETO 867*. \n\nhttps://www.bcn.cl/leychile/navegar?idNorma=1116274' },
    'rule_26': { keywords: ["1814"], response: '*DECRETO 1814*. \n\nhttps://www.bcn.cl/leychile/navegar?idNorma=1069299' },
    'rule_27': { keywords: ["222"], response: '*DECRETO 222*. \n\nhttps://www.bcn.cl/leychile/navegar?idNorma=1055580' },
    'rule_28': { keywords: ["1122"], response: '*DECRETO 1122*. \n\nhttps://www.bcn.cl/leychile/navegar?idNorma=1072929' },
    'rule_29': { keywords: ["41"], response: '*DECRETO 41*. \n\nhttps://www.bcn.cl/leychile/navegar?idNorma=19870' },
    'rule_30': { keywords: ["1772"], response: '*DECRETO 1772*. \nhttps://www.bcn.cl/leychile/navegar?idNorma=18592' },
    'rule_31': { keywords: ["1773"], response: '*DECRETO 1773*. \n\nhttps://www.bcn.cl/leychile/navegar?idNorma=18594' },
    'rule_32': { keywords: ["93"], response: '*DECRETO 93*. \n\nhttps://www.bcn.cl/leychile/navegar?idNorma=9081' },
    'rule_33': { keywords: ["3607"], response: '*D. LEY 3607*. \n\nhttps://www.bcn.cl/leychile/navegar?idNorma=7193' },
    'rule_34': { keywords: ["19303"], response: '*LEY 19303*. \n\nhttps://www.bcn.cl/leychile/navegar?idNorma=30670' },
    'rule_35': { keywords: ["253"], response: '*Resol. 253*. https://www.zosepcar.cl/content/OS10/resolucion_253.pdf' },
    'rule_36': { keywords: ["59"], response: '*Resol. 59*. https://www.zosepcar.cl/content/OS10/resolucion_59.pdf' },
    'rule_37': { keywords: ["32"], response: '*Decreto. 32*. https://www.bcn.cl/leychile/navegar?idNorma=1200633' },
    'rule_38': { keywords: ["80"], response: '*Resol. 80*. https://www.zosepcar.cl/content/OS10/resolucion_80.pdf' },
    'rule_39': { keywords: ["*21659*", "*nueva ley de seguridad*"], response: '*LEY 21659*. https://dal5.short.gy/LeySeg' },
    'rule_60': { keywords: ["cursos","curso"], response: 'ğŸ¤– â¬‡ï¸ *ESCRIBE UNA OPCIÃ“N* ğŸ‘®ğŸ»â€â™‚ï¸ğŸš¦\n*CF.-* CURSO FORMACIÃ“N GUARDIA\n*CJ.-* CURSO JEFE DE SEGURIDAD\n*CE.-* CURSO ENCARGADO\n*CS.-* CURSO SUPERVISOR\n*CT.-* CURSO TÃ‰CNICO\n*CI.-* CURSO INSTALADOR\n*CC.-* CURSO OPERADOR CAJEROS\n*CV.-* CURSO OPERADOR CCTV\n*CP.-* CURSO PERFECCIONAMIENTO' },
    'rule_65': { keywords: ["*fono*", "*telefono*","*numero*","*ubicados*","*direcciÃ³n*","*atenciÃ³n*","*horario*","*horarios*","*ubicaciÃ³n*","*direccion oficina*","*cual es la direcciÃ³n del os10*","*horario atenciÃ³n publico*", "*donde estan*", "*donde esta el os10 coquimbo*", "*donde esta el os10*","*donde*", "*direccion*"], response: 'ğŸ¤– ğŸ‘‰ğŸ¼ *OS10 COQUIMBO*\nDe lunes a jueves de 09:00 horas a 13:00 horas.\nCienfuegos 180, La Serena.\nFonos: 512651024-512651022-\nCredenciales:512651023\nhttps://maps.app.goo.gl/QUhujWbTF1FjDA7E6' },
    'rule_66': { keywords: ["menu","menÃº","menus"], response: '*ESCRIBA LO QUE ESTA CON NEGRILLAS*\nconsultar patente: *ppu*\nConsultar nombre o rut: *rut*\nConsultar guardia *registro*\nmenÃº OS10: *Os10*\nComisaria cuadrantes: *comisaria*\nCiberseguridad: *ciberseguridad*\nDGAC Seg. Priv. *Dgac*\nModifica 261: *Decreto 32*\nResol.3632: *no hay sistema*\nDirectiva: *directiva*\ninfracciÃ³n tto: *infraccion*\nInfracciÃ³n os10: *infraccion os10*\nInfracciÃ³n alcoholes: *infracciÃ³n alcoholes*\nEstadio: *estadio*\nBots: Seguridad privada, Ciberseguridad, trÃ¡nsito, Ley Karyn' },
    'rule_68': { keywords: ["imc"], response: '*CALCULAR IMC*\nhttps://nutricionistavirtual.cl/calculadora/' },
    'rule_69': { keywords: ["curso os10","vigencia curso","tiene curso","si tiene curso"], response: 'ğŸ¤– *GUARDIA / EMPRESA* ğŸ‘®ğŸ»â€â™‚ï¸ ğŸ‘‡ğŸ½ VIGENCIA GG.SS./ VV.PP. /EMP. \nhttps://zosepcar.cl/OS10.php#buscador\n\nğŸ­ *RAZON SOC. / RUT EMP.*ğŸ‘‡ğŸ½\nboletaofactura.com\ngenealog.cl\nmercantil.com\n \nâš–ï¸ *JUZGADO DE TURNO LA SERENA*\nhttps://bit.ly/3GIrWE1' },
    'rule_70': { keywords: ["4651"], response: '*RESOLUCIÃ“N 4651 INASISTENCIA*\n\nhttps://zosepcar.cl/content/OS10/resol_4651.pdf' },
    'rule_71': { keywords: ["empresa capacitacion arica"], response: '*EMPRESA DE CAPACITACIÃ“N ARICA*\n\n*SETCH* FONO: 582251978\n*GSC* FONO: 950144679\n*EDGARDO ABARZUA* FONO: 977777716\n*FUNCAL* FONO: 951490729' },
    'rule_72': { keywords: ["empresa en un dia"], response: '*\"CREA TU EMPRESA EN UN DIA\"* \n https://www.registrodeempresasysociedades.cl/' },
    'rule_73': { keywords: ["insignia digital"], response: '*INSIGNIA DIPLOMADO CIBERSEGURIDAD*\n\nhttps://bit.ly/3DSuD46' },
    'rule_74': { keywords: ["capacitadores"], response: 'ğŸ¤– *CAPACITADORES*\n https://drive.google.com/file/d/1hpZrzhXCnGyLkFLRhj0FOY_zDwTEUIaN/view?usp=drivesdk' },
    'rule_75': { keywords: ["excel reclamos"], response: '*EXCEL RECLAMO* \n\nhttp://bit.ly/3K7ezir' },
    'rule_76': { keywords: ["domicilio figueroa"], response: '*DOMICILIO*\nhttps://maps.app.goo.gl/rnqLdPG5sEFzN32C9' },
    'rule_77': { keywords: ["canales","tv","ver canales","ver tv","ver los canales","retro","retro plus"], response: '*VER CANALES CHILENOS AL MISMO TIEMPO*\nhttps://www.pslabs.cl/tele.html\nhttps://danielfigueroa1879.github.io/prueba/\n\n*CANALES IPTV CHILE*\n1.- ğŸ¤–ğŸ§™ğŸ¼â€â™‚ï¸ *AbrirğŸ‘‡ğŸ¼ con VLC *\nhttps://dal5.short.gy/M' },
    'rule_78': { keywords: ["*votaciones*","*votar*","*excusarme*","*lugar de votaciÃ³n*"], response: '*LUGAR DE VOTACIÃ“N - VOCAL DE MESA*â˜ğŸ¼ğŸ‘ğŸ½\nhttps://consulta.servel.cl/\n*PUEDE LLAMAR AL* 600 600 0166 desde su telÃ©fono\nğŸ¤– *CONSULTAS Y RECLAMOS SERVEL LINK- EXCUSA*: \nhttps://www.servel.cl/contacto/' },
    'rule_79': { keywords: ["cajero"], response: '*INGRESAR CAJERO*\nhttps://forms.gle/68s4SkMqTooU5EdRA' },
    'rule_80': { keywords: ["comisaria","cuadrante","cuadrantes","comisarÃ­as"], response: 'ğŸ¤–ğŸ‘®ğŸ»â€â™‚ï¸ TEL. CUADRANTES\n- https://www.comisariavirtual.cl\n- https://www.stop.carabineros.cl/\n- BUSCA TU CUADRANTE:\nhttps://www.bit.ly/3Yna7AP\n- CUAD. LA SERENA\nhttps://www.dal5.short.gy/C\n- CUAD. LAS COMPAÃ‘IAS\nhttps://www.dal5.short.gy/C1\n- CUAD. COQUIMBO\nhttps://www.dal5.short.gy/Co\n- MAPA CUAD LA SERENA\nhttps://www.d6.short.gy/LS\n- MAPA CUAD COQUIMBO\nhttps://www.d6.short.gy/CQ\n- CEROFILAS\nhttps://www.dal5.short.gy/CFil' },
    'rule_81': { keywords: ["placa patente","ppu"], response: 'ğŸ¤– ğŸš— *BUSCAR PATENTES* ğŸï¸ \npatentechile.com\nvolanteomaleta.com\nwww.autoseguro.gob.cl/\n*RUT*\nhttps://www.rutificador.co/rut/\nhttps://www.elrutificador.com/' },
    'rule_82': { keywords: ["rut","ver un rut"], response: 'ğŸ¤– ğŸ§™ğŸ»â€â™‚ï¸ *Consultar R.U.T.* ğŸ‘‡?\nhttps://www.elrutificador.com/\nhttps://www.nombrerutyfirma.com\nhttps://www.rutynombre.com/\nhttps://www.rutificador.co/rut/' },
    'rule_83': { keywords: ["aaff"], response: '*AA.FF. A NIVEL NACIONAL* ğŸ¤–Busque la comuna que necesita en el mapa. \nhttps://www.zosepcar.cl/OS10.php#autoridad' },
    'rule_84': { keywords: ["actas"], response: 'ğŸ¤– *DESCARGAR ACTAS* \nhttps://dal5.short.gy/Acta' },
    'rule_85': { keywords: ["reclamo","fiscalizacion","fiscalizar"], response: '*REQUERIMIENTO* \n https://dal5.short.gy/R3' },
    'rule_86': { keywords: ["*cuÃ¡l es la pagina del os10*","*zosepcar*"], response: '*ğŸ¤– EstÃ¡ es la pÃ¡gina del os10*\nhttps://www.zosepcar.cl/OS10.php' },
    'rule_87': { keywords: ["reglamento"], response: '*Reglamento 11*\nhttps://drive.google.com/file/d/0By_MScWZi3fRLVlIN2dJby1hekU/view?usp=drivesdk&resourcekey=0-3OB6XmcfWnIf9KZU1J65Yw' },
    'rule_88': { keywords: ["ciberseguridad"], response: 'ğŸ¤– ğŸ§™ğŸ»â€â™‚ï¸ *\"CIBERSEGURIDAD\"*\nâ¢ *1.-Â¿Que Hacer?*:\nhttps://www.dal5.short.gy/SIyeI3\nâ¢ *2.,-Â¿CÃ³mo notificar?*:\nhttps://www.dal5.short.gy/GFxMgX' },
    'rule_89': { keywords: ["menu os10", "menÃº O.S.10"], response: '*De acuerdo OS10*ğŸ§™ğŸ»â€â™‚ï¸ğŸ‘®ğŸ»â€â™‚ï¸â˜ï¸*Escriba lo que estÃ¡ con negrillas:* \n \n â¬‡ï¸ ESCRIBA El QUE NECESITE:\nâ¢ *Bots:* recibirÃ¡ un listado de bots con Inteligencia Avanzada.\nâ¢ *Componentes:* ObtendrÃ¡ las guÃ­as\nâ¢ *Manuales:* Se desplega menu\nâ¢ *Leyes:* Se desplega menu\nâ¢ *Editable:* Documentos en Word.\nâ¢ *Directiva:* Requisitos presentar\nâ¢ *Valores:* Cursos y planes.\nâ¢ *Independiente:* Requisitos Cred.\nâ¢ *Menu credencial:* MenÃº credenciales\nâ¢ *Nueva Ley:* Nueva ley seguridad privada y reglamento.' },
    'rule_90': { keywords: ["*directiva*","*directiva de funcionamiento*","*directivas*","directiva de funcionamiento instalacion","funcionamiento","formulario directiva"], response: 'ğŸ§™ğŸ»â€â™‚ï¸ğŸ¤– *PRESENTAR DIRECTIVA DE FUNCIONAMIENTO*\n(InstalaciÃ³n - Evento - Partidos de FÃºtbol Profesional)\nPagina: https://dal5.short.gy/df' },
    'rule_91': { keywords: ["mantra"], response: '*Mantra*\n\nOm: Om es la sÃ­laba semilla que sintoniza cualquier mantra que se recita en su vibraciÃ³n' },
    'rule_92': { keywords: ["usuario diploma"], response: '*PAGINA DIPLOMADO* https://centropyc.carabineros.cl/acipol/login/index.php Usuario: 982083a ContraseÃ±a: Flor9820&' },
    'rule_93': { keywords: ["auditorias empresa de capacitacion","auditorias empresas de capacitacion","auditoria empresa de capacitacion","auditoria empresas de capacitacion"], response: ',ğŸ‘®ğŸ¼*AUDITORIAS EMPRESA CAPACITACIÃ“N 2024*\n\nhttps://dal5.short.gy/AuCap' },
    'rule_94': { keywords: ["*"], response: 'La siguiente es una conversaciÃ³n con un asistente de IA que usa AutoResponder.ai. El asistente es Ãºtil, creativo, inteligente y muy amigable.' },
    'rule_95': { keywords: ["*independiente*","*credencial independiente*","*credencial independientes*"], response: 'ğŸ¤– *INDEPENDIENTE 1ER. SEM. 2025* \n*Descargar GuÃ­a:* \nhttps://bit.ly/3NNoMC5' },
    'rule_96': { keywords: ["medidas"], response: 'ğŸ¤–ğŸ§™ğŸ»â€â™‚ï¸ *MEDIDAS DE SEGURIDAD*\nâ¢ *MED.EDITABLE:* https://dal5.short.gy/M3' },
    'rule_98': { keywords: ["Valores","cuanto cuesta","cual es el valor","valor plan","valores planes","valores plan","*valor*","*cuesta*"], response: 'ğŸ¤–ğŸ§™ğŸ»â€â™‚ï¸ *AQUI ESTAN LOS VALORES 2DO. SEMESTRE 2025*\n1.- CREDENCIAL\nhttps://dal5.short.gy/val\n2.- CRED. EMPRESA\nhttps://dal5.short.gy/C.emp\n3.- CURSO FORMACIÃ“N\nhttps://dal5.short.gy/Form\n4.- CURSO PERFECC\nhttps://dal5.short.gy/BjzkHI\n5.- VALOR PLAN\nhttps://os10.short.gy/Pl4n' },
    'rule_102': { keywords: ["no hay sistema"], response: 'ğŸ¤– *NO HAY SISTEMA CENTRAL ACTUALMENTE*\nLa resoluciÃ³n 3632 del 30 de Noviembre de 2023 establece que actualmente no existe un sistema central de registro.' },
    'rule_103': { keywords: ["infraccion","infracciones"], response: 'ğŸ¤– *INFRACCIONES TRANSITO*\nhttps://bit.ly/3HFKLaH\nhttps://bit.ly/3ilvbrN\nhttps://bit.ly/3ZcOzb9' },
    'rule_104': { keywords: ["infraccion os10"], response: 'ğŸ¤– *INFRACCIONES OS10*\nSegÃºn decreto 867 y sus modificaciones' },
    'rule_105': { keywords: ["infracciÃ³n alcoholes"], response: 'ğŸ¤– *INFRACCIONES ALCOHOLES*\nLey 19.925 sobre expendio y consumo de bebidas alcohÃ³licas' },
    'rule_106': { keywords: ["estadio"], response: 'ğŸ¤– *ESTADIO*\nRequisitos especiales para eventos deportivos segÃºn circular 28' },
    'rule_107': { keywords: ["bots"], response: 'ğŸ¤– *LISTADO DE BOTS INTELIGENCIA AVANZADA*\n- Bot Seguridad Privada\n- Bot Ciberseguridad\n- Bot TrÃ¡nsito\n- Bot Ley Karyn' },
    'rule_108': { keywords: ["dgac"], response: 'ğŸ¤– *DGAC SEGURIDAD PRIVADA*\nDirecciÃ³n General de AeronÃ¡utica Civil - Requisitos especiales' },
    'rule_109': { keywords: ["decreto 32"], response: '*DECRETO 32/2024*\nModifica decreto 261\nhttps://www.zosepcar.cl/content/OS10/Resol_32.pdf' },
    'rule_110': { keywords: ["*editable*","*documentos word*"], response: 'ğŸ¤– *DOCUMENTOS EDITABLES EN WORD*\nâœ… Estudio\nâœ… Plan\nâœ… Medidas\nâœ… Directiva\nâœ… Todos@ ' },
    'rule_111': { keywords: ["nueva ley"], response: 'ğŸ¤– *NUEVA LEY SEGURIDAD PRIVADA*\nLey 21.659 del 21 de marzo de 2024\nhttps://www.bcn.cl/leychile/navegar?idNorma=1207089' },
    'rule_112': { keywords: ["menu credencial"], response: 'ğŸ¤– *MENÃš CREDENCIALES*\n- Guardia\n- Jefe Seguridad\n- Supervisor\n- Asesor\n- Independiente' },
    'rule_113': { keywords: ["vigilante privado"], response: 'ğŸ¤– *VIGILANTE PRIVADO*\nSimilar a guardia de seguridad pero con funciones especÃ­ficas\nhttps://www.zosepcar.cl/content/OS10/TRAM_vigilante_privado.pdf' },
    'rule_149': { keywords: ["empresas recursos humanos"], response: 'ğŸ¤– *EMPRESAS DE RECURSOS HUMANOS*\nAutorizaciÃ³n especial para intermediaciÃ³n laboral\nRequisitos especÃ­ficos' },
    'rule_150': { keywords: ["*supermercados*","*sobre 500 uf*","*requisitos sobre 500 uf*"], response: 'ğŸ¤– *REQUISITOS SOBRE 500 UF.*\n\nhttps://dal5.short.gy/S500' },
    'rule_152': { keywords: ["linkedin"], response: 'ğŸ§™ğŸ»â€â™‚ï¸.*LinkedIn* \nhttps://dal5.short.gy/Lin' },
    'rule_153': { keywords: ["pdf"], response: 'ğŸ¤– *PDF sh4nge 3dit0r 3d1t0r Plus*\n\n*https://dal5.short.gy/PDF2*' },
    'rule_154': { keywords: ["*facultades*","*fiscalizar vigilante*"], response: 'ğŸ§™ğŸ»â€â™‚ï¸ğŸ‘®ğŸ»â€â™‚ï¸ğŸ¦â˜ï¸ LAS FACULTADES CONFERIDAS A CARABINEROS DE CHILE CONFORME LO SIGUIENTE PARA *VIGILANTES PRIVADOS Y ENTIDAD OBLIGADAS* SEGÃšN EL ARTICULO 3 DEL DECRETO 3.607' },
    'rule_155': { keywords: ["circular","eventos"], response: 'ğŸ¤– *CIRCULAR 28*\n\n*https://www.bcn.cl/leychile/navegar?i=1083082*' },
    'rule_156': { keywords: ["*cursos online*","*modalidad telematica*"], response: 'ğŸ¤– *CURSOS MODALIDAD TELEMATICA* (online)\n\nhttps://www.zosepcar.cl/content/OS10/resolucion_80.pdf' },
    'rule_157': { keywords: ["*guÃ­a de perro*","*perro*"], response: 'ğŸ¤– D/E 164678609OS10 del 28/07/2022.\nğŸ‘®ğŸ•ğŸ•â€ğŸ¦º *INSTRUCCIONES SOBRE ACREDITACIÃ“N DE GUÃAS DE PERROS ADIESTRADOS Y CERTIFICACIÃ“N DE LOS EJEMPLARES*' },
    'rule_160': { keywords: ["*requisitos plan*"], response: 'ğŸ¤– ğŸ“˜ *REQUISITOS PLAN DE SEGURIDAD*\nhttps://dal5.short.gy/RPl4n' },
    'rule_161': { keywords: ["*como presentar una ddff*","*presentar directiva*","*presentar una directiva de funcionamiento*","*presentar ddff*","*presentar dd.ff.*"], response: 'ğŸ¤–ğŸ‘‰ğŸ¼ *COMO SE DEBE PRESENTAR UNA DIRECTIVA DE FUNCIONAMIENTO EN PDF*\nNota- HipervÃ­nculos en el pdf\nhttps://dal5.short.gy/PdDdff' },
    'rule_162': { keywords: ["*por quÃ© no puede en la vÃ­a*","*guardia en la via publica*"], response: 'â˜ğŸ¼ğŸ‘®ğŸ»â€â™‚ï¸ğŸš¦\n*EL GUARDIA DE SEGURIDAD SOLO DEBE REALIZAR SUS LABORES DENTRO DE UN RECINTO O ÃREA DELIMITADA.*' },
    'rule_163': { keywords: ["tiempo"], response: 'ğŸ˜ƒğŸ‘‰ğŸ¼*TIEMPO*\n*Windy*\nhttps://www.windy.com\n*Meteored*\nhttps://www.meteored.cl/mapas-meteorologicos/' },
    'rule_164': { keywords: ["radios"], response: '*RADIOS LA SERENA*\nhttps://onlineradiobox.com/cl/La_Serena' },
    'rule_165': { keywords: ["grupos"], response: 'Grupo trabajos\nhttps://dal5.short.gy/Grup' },
    'rule_166': { keywords: ["*manual cs55*"], response: 'ğŸ¤–ğŸ‘½ğŸ‘‰ğŸ¼ğŸš™ MANUAL CS55 2021\n\nhttps://drive.google.com/file/d/1NrPRmy9ag2pLtd2E5OX0sHfI-x9rCblo/view?usp=drivesdk' },
    'rule_167': { keywords: ["*crear imagen*","*ia imagen*","*imagen ia*"], response: 'ğŸ‘½ğŸ¤–ğŸ‘ŒğŸ¼*IA CREA IMAGEN Y VIDEO*\nhttps://huggingface.co/spaces' },
    'rule_168': { keywords: ["criptografia"], response: 'EstÃ¡s invitado a una reuniÃ³n de Teams.\n\nClases de CriptografÃ­a\n\nhttps://teams.microsoft.com/l/meetup-join' },
    'rule_169': { keywords: ["diplomado"], response: 'ğŸ¤–ğŸ‘‰ğŸ¼ *DIPLOMADO*\n\nhttps://dal5.short.gy/Diplo' },
    'rule_170': { keywords: ["*ley de control de armas*","*armas*"], response: 'ğŸ¤–ğŸ‘‰ğŸ¼LEY DE CONTROL DE ARMAS\n\nhttps://www.bcn.cl/leychile/navegar?i=29291&f=1972-10-21' },
    'rule_171': { keywords: ["*ley de seguridad privada*","*reglamento ley de seguridad privada*","*reglamento*","*reglamentos ley*","*nueva ley*","*21659*"], response: 'ğŸ¤– *NUEVA LEY DE SEGURIDAD PRIVADA*\nâ¢ Reglamento de La Ley\nâ¢ Reglamento de Evento Masivos' },
    'rule_172': { keywords: ["209"], response: 'ğŸ¤– *REGLAMENTO LEY DE SEGURIDAD PRIVADA* https://dal5.short.gy/Regl' },
    'rule_173': { keywords: ["auditorias","instructivo auditorias","auditorÃ­a"], response: 'ğŸ‘®ğŸ¼â˜ğŸ¼ *INSTRUCTIVO AUDITORIAS D/E 142623956*\n1.- Empresas de RR.HH.\n2.- Empresas de TT.VV.\n3.- Empresas de CapacitaciÃ³n' },
    'rule_174': { keywords: ["binance","recibir criptomonedas"], response: 'ğŸ¤–ğŸª™ğŸ’°ğŸª™ğŸ‘‰ğŸ¼ ğŸ’¸*RECIBIR CRIPTO EN BINANCE*\n*Recibir:*\n 0x78b349586f9de0ad692549b20e0efba58df1ff79' },
    'rule_175': { keywords: ["partido","futbol","copa amÃ©rica","donde ver futbol"], response: 'ğŸ‘½ğŸ‘‰ğŸ¼ *VER FUTBOL ONLINE O DESCARGAR APP*\n\nğŸ‘‰ğŸ¼ *VER ONLINE*: LINK : https://futbollibrehd.cl/' },
    'rule_177': { keywords: ["doodieman"], response: '*Doodieman*\nhttps://www.1001juegos.com/juego/doodieman-voodoo' },
    'rule_178': { keywords: ["usek","anexos"], response: 'ğŸ¤– *ANEXOS* \nLink: https://anexos.usek.cl/\nPdf: https://www.dal5.short.gy/Kj2AUu' },
    'rule_179': { keywords: ["calendario clases"], response: 'ğŸ¤–ğŸ‘®ğŸ¼ğŸ‘‰ğŸ¼ *CALENDARIO CLASES* https://www.dal5.short.gy/ie1DxQ' },
    'rule_180': { keywords: ["prompts","pront","prom","pron","promt","promtsp","promstp"], response: 'ğŸ¤–ğŸ‘‰ğŸ¼ *PROMPTS*\n\nCrear App\nhttps://dal5.short.gy/CreaApp' },
    'rule_181': { keywords: ["estudios"], response: 'ğŸ¤–ğŸ‘‰ğŸ¼ *TECNICO DE NIVEL SUPERIOR EN TRABAJO SOCIAL*\nhttps://www.dal5.short.gy/SU' },
    'rule_182': { keywords: ["currÃ­culum"], response: 'ğŸ¤–ğŸ‘ğŸ¼ *CURRÃCULUM VITAE* \nhttps://dal5.short.gy/CV' },
    'rule_183': { keywords: ["registro pampilla","ingreso pampilla"], response: 'ğŸ¤–ğŸ‘®ğŸ¼ğŸ‘‰ğŸ¼ *REGISTRO DE INGRESO* ğŸŸï¸\n\nhttps://dal5.short.gy/Estadio' },
    'rule_185': { keywords: ["foto ia","ia foto","agrandar foto","ampliar foto","herramientas de inteligencia artificial","inteligencia","cambiar fondo"], response: 'ğŸ¤–â˜ğŸ¼ *HERREMIENTAS DE INTELIGENCIA ARTIFICIAL*\n\n1.- *Laboratorio de Google IA*\nlabs.google/fx/es' },
    'rule_186': { keywords: ["diplomados"], response: '*DANIEL FIGUEROA* \n*INGENIERO EN INFORMÃTICA*\nhttps://drive.google.com/file/d/1k2oiHE9VkBsU8MdFsRo6uFYYnDh-tEs1/view?usp=drivesdk' },
    'rule_187': { keywords: ["registro estadio","estadio"], response: 'ğŸ¤– *DEJAR REGISTRO ESTADIO*\n1.- *ESTE ES EL EXCEL:*\nhttps://dal5.short.gy/Estad' },
    'rule_188': { keywords: ["trabajo"], response: '*Seguridad IOT*\nTRABAJO 3 INDIVIDUAL \n\nhttps://docs.google.com/document/d/1gDgNpIwkqmGK2GTJ_sTP1O1Dx1ZDnmR9/edit' },
    'rule_192': { keywords: ["que significa atm","significado atm"], response: 'ğŸ¤– ATM (Automated Teller Machine)' },
    'rule_193': { keywords: ["tejidos","tejido","tejer","tejidos luna"], response: 'ğŸ¤– *TEJIDOS LUNA*ğŸ‘‡ğŸ½ğŸ¦´ğŸ•\n\nhttps://dal5.short.gy/Tej3' },
    'rule_194': { keywords: ["14 puntos cajeros"], response: 'ğŸ¤– *14 PUNTOS CAJEROS*\n\nMi XXXXXXX se informa el siguiente procedimiento' },
    'rule_195': { keywords: ["*Â¿los dÃ­as de votaciÃ³n serÃ¡n feriados?"], response: '*Â¿Los dÃ­as de votaciÃ³n serÃ¡n feriados?*\n\nSÃ­. El sÃ¡bado 26 de octubre serÃ¡ feriado normal, por lo que el comercio podrÃ¡ abrir. Mientras que el domingo 27 de octubre serÃ¡ feriado irrenunciable.' },
    'rule_196': { keywords: ["bots","tienes un bot","hay un bot","tiene algÃºn bot de seguridad privada","algun bot","tiene un bot","dame el bot","bot de seguridad privada","bot"], response: 'ğŸ¤– *Bots con IA avanzada:*\n\nâ¢ *Bot Seguridad Privada*\nhttps://dal5.short.gy/SePriv' },
    'rule_197': { keywords: ["colores"], response: 'ğŸ¤– *Colores votaciones* \nhttps://drive.google.com/file/d/1qAQoR_DRaXl8Cgzfueyx2ggh2LL_caBh/view?usp=drivesdk' },
    'rule_198': { keywords: ["*para tramitar una credencial de guardia*","*credencial de guardia*"], response: 'ğŸ‘®ğŸ½â€â™‚ï¸ğŸ‘‰ğŸ¼ Existen dos tipos de credenciales para guardia de seguridad, escribe lo que estÃ¡ con negrillas del que necesitas:\n*1. Independiente:* (solo eventos)\n*2. Credencial Empresa* (instalaciÃ³n empresa)' },
    'rule_199': { keywords: ["*bot*","*bot seguridad privada*"], response: 'ğŸ¤–ğŸ‘®ğŸ½â€â™‚ï¸ğŸ‘‰ğŸ¼ *Bots con IA avanzada Chat Gpt 4o:*\n\nğŸ¤– *Bot de Seguridad Privada* https://dal5.short.gy/SePriv' },
    'rule_201': { keywords: ["y tiene los valores","y tiene los valores del plan","credencial empresa","los valores","valores credencial","valor","cual es el valor","cuanto cuesta","plan"], response: 'Si, claro: ğŸ¤–ğŸ§™ğŸ»â€â™‚ï¸ *AQUI ESTAN LOS VALORES 2DO. SEMESTRE 2024*\n\n1.- *CREDENCIAL*\nhttps://bit.ly/3vmqEvz' },
    'rule_202': { keywords: ["registro ingreso biometrico"], response: 'ğŸ¤–ğŸ‘‰ğŸ¼ *Registro ingreso BiomÃ©trico*\n\nhttps://dal5.short.gy/Reg' },
    'rule_203': { keywords: ["sacar cantidad de guardias por evento","guardia por evento","cantidad de guardias","cuantos guardias","guardias por evento"], response: 'ğŸ¤–ğŸ‘®ğŸ¼â€â™‚ï¸ğŸ‘‰ğŸ¼ *CANTIDAD DE GUARDIA POR EVENTO:* \n \n*Link:*\n*https://dal5.short.gy/GGSS*' },
    'rule_204': { keywords: ["hora dipreca","para sacar hora en dipreca","sacar hora dipreca","dipreca"], response: 'Gracias por contactarse con DIPRECA. \n*Informamos que desde el 13 de Junio este whatsapp dejÃ³ de funcionar*' },
    'rule_206': { keywords: ["os11","arma","inscripciÃ³n de un arma","trÃ¡mites os11","tramites os11"], response: 'ğŸ§™ğŸ¼â€â™‚ï¸ğŸ¤–ğŸ‘‰ğŸ¼ *Portal de consultas de armas*\n https://www.portalarmaschile.gob.cl/' },
    'rule_207': { keywords: ["certificado","certificados","como sacar certificado os10","cerofilas","cero filas","0 filas"], response: 'ğŸ‘®ğŸ½â€â™‚ï¸ ğŸ‘‰ğŸ¼ *TRÃMITES CEROFILAS*:\n\nLink: https://dal5.short.gy/CFil' },
    'rule_208': { keywords: ["dpi"], response: '*LOS DPI AFECTAN ÃšNICAMENTE LA RESOLUCIÃ“N DE IMPRESIÃ“N, NO EL TAMAÃ‘O FÃSICO DE LA IMAGEN EN PÃXELES.*' },
    'rule_209': { keywords: ["7 puntos","7 puntos accidente de transito"], response: '*1. TIPIFICACIÃ“N:* ROBO VEHÃCULO AFECTA CONSEJAL COMUNA VITACURA.' },
    'rule_213': { keywords: ["fotografÃ­a","fotito"], response: '*1.- FOTOSTORE:* Calle Prat 629, La Serena.\nUbicaciÃ³n: *https://dal5.short.gy/629*' },
    'rule_215': { keywords: ["sacar hora dental","dentista","sacar hora"], response: 'ğŸ¤– *SACAR HORA DENTISTA CARABINEROS LA SERENA O SANTIAGO.*\n*https://www.hoscar.cl/v2.0/horasdentales/login.php*' },
    'rule_216': { keywords: ["valor infracciones","valores infracciones","cuanto cuesta una infracciÃ³n de seguridad privada"], response: ',ğŸ¤–â˜ğŸ¼ Dado que las multas establecidas en la Ley 21.659 se expresan en UTM' },
    'rule_220': { keywords: ["pagina"], response: 'ğŸ§™ğŸ¼â€â™‚ï¸ *PAGINA CIBERSEGURIDAD*\n*https://dal5.short.gy/C25*' },
    'rule_221': { keywords: ["estadio 2"], response: 'ğŸ¤–ğŸ§™ğŸ¼â€â™‚ï¸ *DEJAR REGISTRO ESTADIO 2*\n\n1.-*Link de ingreso en pÃ¡gina web PC*' },
    'rule_222': { keywords: ["bot telegram"], response: '*Bots telegram*\n1.- Borra fondo: AI_Background_Remover_Bot' },
    'rule_223': { keywords: ["cÃ©dula","cÃ©dula de identidad"], response: '*CÃ‰DULA DE IDENTIDAD 2025*\nhttps://dal5.short.gy/Ce' },
    'rule_224': { keywords: ["ia","ai","avanzada","ias","ias avanzada","ia avanzada","ai avanzada"], response: ',ğŸ§™ğŸ¼â€â™‚ï¸ *IA AVANZADA 2025*\n1.- https://chat.qwenlm.ai/' },
    'rule_225': { keywords: ["estadio coquimbo","informe estadio coquimbo"], response: 'Buenas tardes, *OS10 Coquimbo* remite el siguiente Informe:\n\nğŸŸï¸ *INFORME ESTADIO*' },
    'rule_226': { keywords: ["estadio la serena"], response: 'Buenas tardes, *OS10 Coquimbo* remite el siguiente Informe: \n\nğŸŸï¸ *INFORME ESTADIO*' },
    'rule_227': { keywords: ["preventiva"], response: 'ğŸ¤– *PREVENTIVA*\nhttp://www.medpreventiva.dipreca.cl:8098/autoconsulta/ingresarut.asp' },
    'rule_238': { keywords: ["pensiones","calculo pensiÃ³n","jubilaciÃ³n","retiro","pensiÃ³n","retirarme","retirarse"], response: 'ğŸ§™ğŸ¼â€â™‚ï¸ *Calculo Pensiones*\ndal5.short.gy/Pens' },
    'rule_239': { keywords: ["directiva","directiva de funcionamiento","directivas","directiva de funcionamiento instalacion","funcionamiento","formulario directiva"], response: 'ğŸ¤– *PAGINA PARA:*\n*1.- PRESENTAR DIRECTIVA.*\n*2.- CREDENCIAL EMPRESA.*\n*3.- CRED. INDEPENDIENTE.*' },
    'rule_240': { keywords: ["credencial empresa","credencial empleador","cred empresa","*credencial empresas*","credenciales empresas","credencial","*credencial independiente*","*independiente*","credencial independientes","*tramitar credencial*"], response: '*TRAMITAR CREDENCIALES* ğŸ¤–ğŸ‘‰ğŸ¼ https://directiva.netlify.app/credenciales \naquÃ­ salen los pasos a seguir para tramitar una credencial.' },
    'rule_243': { keywords: ["realizaron examen","los que realizaron el examen","enviar el resultado examen","enviar resultado","enviar resultados"], response: 'ğŸ¤– ğŸ‘®ğŸ¼â€â™‚ï¸\n1.- Los que estÃ¡n con rojo sacaron bajo el 60% y estÃ¡n reprobados' },
    'rule_244': { keywords: ["usuario portal","portal usuario","portal de usuario","usuario"], response: 'ğŸ§™ğŸ¼â€â™‚ï¸\nhttps://dal5.short.gy/U53' },
    'rule_245': { keywords: ["presentaciÃ³n con ia","presentaciÃ³nes"], response: 'ğŸ¤–ğŸ§™ğŸ¼â€â™‚ï¸ \n\n1.- https://gamma.app/' },
    'rule_246': { keywords: ["plano oficina"], response: 'ğŸ¤– Plano Oficina \nhttps://os10.short.gy/Pl40' },
    'rule_247': { keywords: ["requerimiento de desarrollo web","requerimiento pÃ¡gina","pÃ¡gina","requisitos pÃ¡gina","crear pÃ¡gina web","desarrollo web"], response: 'ğŸ¤–ğŸ§™ğŸ¼â€â™‚ï¸ ğŸ’¡ğŸ¥‡ *Para saber que es lo que necesita, responder lo siguiente*\n\n*1.- Requerimiento de desarrollo*\nhttps://dal5.short.gy/D3sa' },
    'rule_248': { keywords: ["servidor","servidores","alojar pÃ¡gina","alojar"], response: 'ğŸ§™ğŸ¼â€â™‚ï¸*Alojar pÃ¡ginas web*\n1.- https://app.netlify.com/\n2.- https://github.com/' },
    'rule_252': { keywords: ["requisitos","requisito","requisitos plan","requisitos medidas","requisitos directiva"], response: 'ğŸ¤–ğŸ§™ğŸ¼â€â™‚ï¸ *Requisitos Plan, Medidas y Directiva*\nhttps://os10coquimbo.netlify.app' },
    'rule_253': { keywords: ["valores infracciones ciberseguridad","infracciones de ciberseguridad","infracciones ciberseguridad"], response: 'ğŸ¤–ğŸ§™ğŸ¼â€â™‚ï¸*VALORES INFRACCIONES DE CIBERSEGURIDAD*\nhttps://dal5.short.gy/Vc' },
    'rule_254': { keywords: ["*examen os10*","examen"], response: 'ğŸ§™ğŸ¼â€â™‚ï¸ğŸ¤–ğŸ‘®ğŸ¼â€â™‚ï¸ *Practicar examen*\nhttps://dal5.short.gy/SeSec' },
    'rule_255': { keywords: ["*examen moto*","examen para moto","moto"], response: 'ğŸ¤–ğŸ§™ğŸ¼â€â™‚ï¸ *Examen moto*\nhttps://dal5.short.gy/ExMoto' },
    'rule_256': { keywords: ["honorarios"], response: '*HONORARIOS*\nhttps://rentab.netlify.app/' },
    'rule_257': { keywords: ["gestudio","estudiar","gestor acadÃ©mico","gestor"], response: 'ğŸ¤–ğŸ§™ğŸ¼â€â™‚ï¸âœ…\n\nhttps://gestudios.netlify.app/' },
    'rule_258': { keywords: ["*quien es tu creador*","*quien te creo*"], response: 'ğŸ¤–ğŸ§™ğŸ¼â€â™‚ï¸âœ… Mi creador es todo el equipo de Profesionales que se encuentra trabajando en la oficina de seguridad Privada OS10 Coquimbo y el\n*Ingeniero en InformÃ¡tica y Ciberseguridad Daniel Figueroa Chacama*' }
};

// --- API Configuration ---
const API_KEY = 'AIzaSyAgOFzsnwwLt4TSb1lO3XZ8Ot9QJUX7Y6A';
const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`;

// --- State Management ---
let chatHistory = [];
const systemPrompt = `Eres un asistente virtual y funcionario de la oficina de Seguridad Privada OS10 de Carabineros en Coquimbo, Chile. Tu principal objetivo es ayudar a los usuarios con sus trÃ¡mites y consultas, responde como si fueras un experto en Seguridad Privada, profesional
Tus reglas principales son:
1.  **Asume tu Rol:** Responde siempre como si fueras un miembro del equipo de la oficina OS10 Coquimbo. Usa un tono servicial y profesional.
2.  **Prioridad a los documentos:** Tu mÃ¡xima prioridad es buscar y entregar primero cualquier documento, guÃ­a o PDF que tengas en tu base de datos cuando se te pregunte por un trÃ¡mite (ej. "cÃ³mo tramitar credencial"). Una vez entregado el documento, puedes responder preguntas adicionales.
3.  **Respuestas cortas y reales:** SÃ© conciso y factual. No inventes respuestas. Si no sabes algo, indÃ­calo amablemente.
4.  **Formato claro:** Usa Markdown para dar formato. Para listas, asegÃºrate de que cada Ã­tem estÃ© en una nueva lÃ­nea (ej. "1. Guardia\\n2. Vigilante").
5.- **OS10 COQUIMBO, OFICINA DE SEGURIDAD PRIVADA OS10 COQUIMBO, OFICINA, OS10:** Es una oficina que se ecuentra en en el centro de La Serena, su direccion es Calle Cienfuegos NÂ°180, La Serena, su fono o telefono es el siguiente: 51 2 651024 o el 51 2 651023, su correo es *os10.couimbo@carabineros.cl* - *os10coquimbo@gmail.com*
6.  **infracciones del os10:** las principales infracciones de guardia de seguridad son las siguiente: sin curso os10 art. 13 del decreto 93, sin directiva de funcionamiento art. 15 del decreto 93, sin credencial de guardia (gg.ss) art 18 del decreto 93, guardia de seguridad no puede usar armamento art. 14 decreto 93, sin uniforme reglamentario art. 8vo del decrero 867 y decreto 23/2024. 

Genera respuestas usando Markdown para formato, como **negrita** para Ã©nfasis y listas con * o nÃºmeros.`;

// --- OPTIMIZATION: Pre-build a map for faster predefined response lookups ---
let responseMap = new Map();
let partialMatchRules = [];

/**
 * Processes the predefinedResponses object into faster lookup structures.
 * This function runs only once on initialization.
 */
function buildResponseMap() {
    const newResponseMap = new Map();
    const newPartialMatchRules = [];

    for (const key in predefinedResponses) {
        const item = predefinedResponses[key];
        for (const keyword of item.keywords) {
            const normalizedKeyword = keyword.toLowerCase().trim();
            
            if (normalizedKeyword.startsWith('*') && normalizedKeyword.endsWith('*')) {
                // This is a partial match rule (e.g., *word*)
                const cleanKeyword = normalizedKeyword.substring(1, normalizedKeyword.length - 1);
                if(cleanKeyword) {
                    newPartialMatchRules.push({ keyword: cleanKeyword, response: item.response });
                }
            } else {
                // This is an exact match rule
                newResponseMap.set(normalizedKeyword, item.response);
            }
        }
    }
    responseMap = newResponseMap;
    partialMatchRules = newPartialMatchRules;
    console.log("Response map built successfully.", {exactMatches: responseMap.size, partialMatches: partialMatchRules.length});
}


// --- UI Functions ---

/**
 * Toggles the visibility of the chat popup and the open/close icons.
 */
function toggleChat() {
    chatPopup.classList.toggle('hidden');
    chatBackdrop.classList.toggle('hidden');
    chatToggleButton.classList.toggle('hidden');

    // Ensure fullscreen mode is exited when chat is closed
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    if (isMobile) {
        chatWidgetContainer.classList.remove('fullscreen');
        // Reset inline styles to allow CSS classes to take over
        chatWidgetContainer.style.height = '';
        chatWidgetContainer.style.bottom = '';
    }
}

/**
 * Converts basic Markdown syntax (and URLs) to HTML for rendering in the chat.
 * @param {string} text - The raw text from the API or predefined responses.
 * @returns {string} - The text formatted with HTML tags.
 */
function markdownToHtml(text) {
    if (!text) return '';
    // 1. Convert URLs to clickable links.
    let formattedText = text.replace(/(https?:\/\/[^\s"'<>`]+)/g, '<a href="$1" target="_blank" class="text-blue-400 dark:text-blue-300 hover:underline">$1</a>');
    // 2. Convert bold (asterisks): *text* or **text** -> <b>text</b>
    formattedText = formattedText.replace(/\*(\*?)(.*?)\1\*/g, '<b>$2</b>');
    // 3. Convert bullet points: * item -> ğŸ”¹ item
    formattedText = formattedText.replace(/^\s*-\s/gm, 'ğŸ”¹ ');
    // 4. Convert newlines to <br>
    return formattedText.replace(/\n/g, '<br>');
}


/**
 * Creates and appends a message to the chat UI.
 * @param {string} sender - The sender of the message ('user' or 'bot').
 * @param {string} text - The content of the message (raw text for user, HTML for bot).
 * @param {string[]} [buttons=[]] - An optional array of strings to create as buttons.
 */
function addMessage(sender, text, buttons = []) {
    const messageElement = document.createElement('div');
    messageElement.className = 'message-fade-in flex items-start max-w-xs md:max-w-sm';

    const isUser = sender === 'user';
    messageElement.classList.toggle('ml-auto', isUser);
    messageElement.classList.toggle('flex-row-reverse', isUser);

    const bubble = document.createElement('div');
    bubble.className = isUser 
        ? 'bg-green-500 rounded-xl rounded-br-none p-3 ml-2' 
        : 'bot-bubble rounded-xl rounded-bl-none p-3 ml-2';

    const p = document.createElement('p');
    p.className = isUser ? 'text-white text-base' : 'text-gray-700 dark:text-gray-200 text-sm';
    
    // Sanitize user input, allow HTML for bot responses
    if (isUser) {
        p.textContent = text;
    } else {
        p.innerHTML = markdownToHtml(text);
    }
    
    bubble.appendChild(p);
    
    // Handle buttons for bot messages
    if (!isUser && buttons.length > 0) {
        const buttonContainer = document.createElement('div');
        buttonContainer.className = 'mt-2 flex flex-col space-y-2';
        buttons.forEach(buttonText => {
            const button = document.createElement('button');
            button.textContent = buttonText;
            button.className = 'bg-green-100 dark:bg-gray-700 border border-green-500/50 text-green-800 dark:text-green-300 text-sm py-1.5 px-3 rounded-lg hover:bg-green-200 dark:hover:bg-gray-600 transition-colors w-full text-left font-medium';
            button.onclick = () => {
                userInput.value = buttonText;
                handleSendMessage();
            };
            buttonContainer.appendChild(button);
        });
        bubble.appendChild(buttonContainer);
    }

    // Avatar
    const avatar = document.createElement('div');
    if (isUser) {
        avatar.className = 'w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-600 flex items-center justify-center font-bold text-sm flex-shrink-0 text-gray-600 dark:text-gray-300';
        avatar.textContent = 'U';
    } else {
        avatar.className = 'w-8 h-8 rounded-full bg-white border-2 border-yellow-400 flex items-center justify-center flex-shrink-0 p-1';
        avatar.innerHTML = `<img src="assets/images/poli.png" alt="Bot Icon" class="h-full w-full object-contain">`;
    }

    messageElement.appendChild(avatar);
    messageElement.appendChild(bubble);
    chatMessages.appendChild(messageElement);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

/**
 * Shows or hides the typing indicator in the chat.
 * @param {boolean} show - Whether to show or hide the indicator.
 */
function showTypingIndicator(show) {
    let indicator = document.getElementById('typing-indicator');
    if (show && !indicator) {
        indicator = document.createElement('div');
        indicator.id = 'typing-indicator';
        indicator.className = 'message-fade-in flex items-start';
        indicator.innerHTML = `
            <div class="w-8 h-8 rounded-full bg-white border-2 border-yellow-400 flex items-center justify-center flex-shrink-0 p-1">
                 <img src="assets/images/poli.png" alt="Bot Icon" class="h-full w-full object-contain">
            </div>
            <div class="bot-bubble rounded-xl rounded-bl-none p-3 ml-2 typing-indicator">
                <span></span><span></span><span></span>
            </div>
        `;
        chatMessages.appendChild(indicator);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    } else if (!show && indicator) {
        indicator.remove();
    }
}

/**
 * Finds a predefined response using the optimized maps.
 * @param {string} text - The user's input text.
 * @returns {string|null} The predefined response or null if no match.
 */
function getPredefinedResponse(text) {
    const lowerCaseText = text.toLowerCase().trim();
    
    // 1. Check for an exact match (fastest)
    if (responseMap.has(lowerCaseText)) {
        return responseMap.get(lowerCaseText);
    }

    // 2. Check for partial matches (slower, but necessary)
    for (const rule of partialMatchRules) {
        if (lowerCaseText.includes(rule.keyword)) {
            return rule.response;
        }
    }

    return null; // No match found
}


// --- API Communication ---

/**
 * Sends the user's message, checking for predefined responses first.
 */
async function handleSendMessage() {
    const userText = userInput.value.trim();
    if (!userText) return;

    addMessage('user', userText);
    userInput.value = '';
    
    const predefinedResponse = getPredefinedResponse(userText);
    if (predefinedResponse) {
        setTimeout(() => {
            addMessage('bot', predefinedResponse);
            chatHistory.push({ role: "user", parts: [{ text: userText }] });
            chatHistory.push({ role: "model", parts: [{ text: predefinedResponse }] });
        }, 500);
        return;
    }
    
    showTypingIndicator(true);
    chatHistory.push({ role: "user", parts: [{ text: userText }] });

    try {
        const payload = {
            contents: chatHistory,
            systemInstruction: { role: "system", parts: [{ text: systemPrompt }] },
            generationConfig: { temperature: 0.7, maxOutputTokens: 1024 },
        };

        const response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || `API Error: ${response.status}`);
        }

        const data = await response.json();
        const botText = data.candidates?.[0]?.content?.parts?.[0]?.text || "No obtuve una respuesta.";
        
        chatHistory.push({ role: "model", parts: [{ text: botText }] });
        addMessage('bot', botText);

    } catch (error) {
        console.error('Error fetching from Gemini API:', error);
        addMessage('bot', `Lo siento, ocurriÃ³ un error al contactar al asistente. (${error.message})`);
    } finally {
        showTypingIndicator(false);
    }
}

// --- Initialization ---

/**
 * Initializes the chatbot, sets up event listeners, and displays a welcome message.
 */
function init() {
    if (!chatToggleButton) {
        console.error("Chatbot UI elements not found. Initialization failed.");
        return;
    }
    
    buildResponseMap();

    // Event Listeners
    chatToggleButton.addEventListener('click', toggleChat);
    internalCloseBtn.addEventListener('click', toggleChat);
    sendButton.addEventListener('click', handleSendMessage);
    userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            handleSendMessage();
        }
    });
    
    // Mobile keyboard handling
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    if (isMobile) {
        let isFirstFocus = true;

        const setFullscreen = () => {
            if (isFirstFocus) {
                chatWidgetContainer.classList.add('fullscreen');
                isFirstFocus = false;
            }
            if (window.visualViewport) {
                // Set the container height to the visible area and scroll to the bottom
                const viewportHeight = window.visualViewport.height;
                chatWidgetContainer.style.height = `${viewportHeight}px`;
                chatWidgetContainer.style.bottom = '0';
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        };

        userInput.addEventListener('focus', setFullscreen);

        if (window.visualViewport) {
            window.visualViewport.addEventListener('resize', () => {
                // Only adjust if we are in fullscreen mode
                if (chatWidgetContainer.classList.contains('fullscreen')) {
                    setFullscreen();
                }
            });
        }
        
        // Reset the fullscreen state when the chat is closed
        const resetMobileState = () => {
            isFirstFocus = true;
            chatWidgetContainer.classList.remove('fullscreen');
            chatWidgetContainer.style.height = '';
            chatWidgetContainer.style.bottom = '';
        };

        internalCloseBtn.addEventListener('click', resetMobileState);
        chatBackdrop.addEventListener('click', resetMobileState);
    }

    // Display welcome message
    const welcomeMessageText = "Â¡Hola! Soy tu asistente virtual de la oficina OS10 Coquimbo. Â¿En quÃ© puedo ayudarte hoy?";
    const welcomeButtons = ["MenÃº", "MenÃº O.S.10", "Valores"];
    addMessage('bot', welcomeMessageText, welcomeButtons);
    
    // Add welcome message to history for context
    chatHistory.push({ role: "model", parts: [{ text: welcomeMessageText }] });

    console.log("Chatbot initialized successfully.");
}

document.addEventListener('DOMContentLoaded', init);
