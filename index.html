<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soluci√≥n: Carga de Reglas Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-6">
        <h1 class="text-3xl font-bold text-blue-600 mb-6">üîß Soluci√≥n: Carga de Base de Datos de Reglas</h1>
        
        <!-- Diagn√≥stico del Problema -->
        <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
            <h2 class="text-xl font-semibold text-red-800 mb-3">üîç Problema Identificado</h2>
            <p class="text-red-700 mb-2">El archivo <code>rules/chatbot-rules.js</code> no se est√° cargando correctamente.</p>
            <p class="text-sm text-red-600">Esto puede deberse a:</p>
            <ul class="list-disc pl-5 text-sm text-red-600 mt-2">
                <li>Estructura del archivo JavaScript incorrecta</li>
                <li>Orden de carga de scripts</li>
                <li>Problemas de ruta relativa</li>
                <li>Variables globales no accesibles</li>
            </ul>
        </div>

        <!-- Herramienta de Diagn√≥stico en Vivo -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <h2 class="text-xl font-semibold text-blue-800 mb-3">üß™ Herramienta de Diagn√≥stico</h2>
            <div class="space-y-3">
                <button onclick="checkRulesLoading()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    üìã Verificar Carga de Reglas
                </button>
                <button onclick="testRulesStructure()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    üîç Probar Estructura de Reglas
                </button>
                <button onclick="simulateRulesSearch()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                    üîé Simular B√∫squeda en Reglas
                </button>
                <button onclick="downloadCorrectRulesFile()" class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600">
                    üì• Generar Archivo Corregido
                </button>
            </div>
            <div id="diagnostic-output" class="mt-4 p-3 bg-gray-50 rounded min-h-[150px] font-mono text-sm whitespace-pre-wrap">
Haz clic en los botones para ejecutar diagn√≥sticos...
            </div>
        </div>

        <!-- Soluci√≥n 1: Estructura Correcta del Archivo -->
        <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
            <h2 class="text-xl font-semibold text-green-800 mb-3">‚úÖ Soluci√≥n 1: Estructura Correcta de chatbot-rules.js</h2>
            <p class="text-green-700 mb-3">Aseg√∫rate de que tu archivo <code>rules/chatbot-rules.js</code> tenga esta estructura:</p>
            
            <pre class="bg-black text-green-400 p-4 rounded text-xs overflow-x-auto"><code>// ===== ARCHIVO: rules/chatbot-rules.js =====

// Sistema de Respuestas del Chatbot OS10 Coquimbo
console.log('üîÑ Cargando base de datos de reglas OS10...');

// Objeto principal de respuestas
const responses = {
    'rule_1': { 
        keywords: ["*bots*","*tienes algun bots*","*bots de ciberseguridad*"], 
        response: 'ü§ñ *Bots con IA avanzada:* \n *1 Bot Seguridad Privada* \n dal5.short.gy/SePriv *2 Bot de Ciberseguridad 2024* \n dal5.short.gy/Cib' 
    },
    'rule_2': { 
        keywords: ["infracciones", "sanciones guardias"], 
        response: 'Infracciones de Guardias (Decreto Supremo N¬∞ 93)...' 
    },
    // ... todas tus reglas aqu√≠
    'rule_350': { 
        keywords: ["*donde puedo hacer el curso*","*empresa capacitadora*"], 
        response: 'ü§ñüßôüèº‚Äç‚ôÇÔ∏è‚úÖ Estas son algunas empresas de aqui de la region...' 
    },
    'rule_351': { 
        keywords: ["*quien es tu creador*","*quien te creo*"], 
        response: 'ü§ñüßôüèº‚Äç‚ôÇÔ∏è‚úÖ Mi creador es el\n*Ingeniero en Inform√°tica y Ciberseguridad \nDaniel El√≠as Figueroa Chacama*' 
    }
};

// Prompt del sistema
const systemPrompt = `Eres un asistente virtual y funcionario de la oficina de Seguridad Privada OS10 de Carabineros en Coquimbo, Chile. Tu principal objetivo es ayudar a los usuarios con sus tr√°mites y consultas, responde como si fueras un experto en Seguridad Privada, profesional.

Tus reglas principales son:
1. **Asume tu Rol:** Responde siempre como si fueras un miembro del equipo de la oficina OS10 Coquimbo.
2. **Prioridad a los documentos:** Tu m√°xima prioridad es buscar y entregar primero cualquier documento, gu√≠a o PDF.
3. **Respuestas cortas y reales:** S√© conciso y factual. No inventes respuestas.
4. **Formato claro:** Usa Markdown para dar formato.
5. **OS10 COQUIMBO:** Oficina ubicada en Calle Cienfuegos N¬∞180, La Serena, fono: 51 2 651024.
6. **Infracciones principales:** sin curso os10 art. 13, sin directiva art. 15, sin credencial art 18, etc.
7. **Nueva Ley:** Ley 21.659 entra en vigencia el 28-NOV-2025.
8. **Infracciones ordenadas:** Siempre enumerar con negrillas.
9. **Resumen de ley:** Proporcionar informaci√≥n detallada cuando se solicite.`;

// Funci√≥n de verificaci√≥n de carga
function verifyRulesLoaded() {
    console.log('‚úÖ Verificando carga de reglas...');
    console.log(`üìä Total de reglas cargadas: ${Object.keys(responses).length}`);
    console.log('üìã Primeras 5 reglas:', Object.keys(responses).slice(0, 5));
    return {
        loaded: true,
        count: Object.keys(responses).length,
        sample: Object.keys(responses).slice(0, 5)
    };
}

// Funci√≥n para buscar reglas
function searchRules(userInput) {
    const lowerInput = userInput.toLowerCase();
    console.log(`üîç Buscando reglas para: "${userInput}"`);
    
    for (const [ruleId, rule] of Object.entries(responses)) {
        if (rule && rule.keywords) {
            for (const keyword of rule.keywords) {
                const cleanKeyword = keyword.replace(/\*/g, '');
                if (lowerInput.includes(cleanKeyword)) {
                    console.log(`‚úÖ Regla encontrada: ${ruleId} -> ${cleanKeyword}`);
                    return rule.response;
                }
            }
        }
    }
    console.log('‚ùå No se encontr√≥ regla matching');
    return null;
}

// Hacer las variables globalmente accesibles
window.responses = responses;
window.systemPrompt = systemPrompt;
window.verifyRulesLoaded = verifyRulesLoaded;
window.searchRules = searchRules;

// Verificaci√≥n autom√°tica al cargar
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ DOM cargado, verificando reglas...');
    const verification = verifyRulesLoaded();
    console.log('üìã Resultado verificaci√≥n:', verification);
});

console.log('‚úÖ Base de datos de reglas OS10 cargada correctamente');
console.log(`üìä ${Object.keys(responses).length} reglas disponibles`);</code></pre>
        </div>

        <!-- Soluci√≥n 2: Orden de Scripts en HTML -->
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
            <h2 class="text-xl font-semibold text-yellow-800 mb-3">‚ö° Soluci√≥n 2: Orden Correcto de Scripts en HTML</h2>
            <p class="text-yellow-700 mb-3">En tu archivo HTML, aseg√∫rate de que los scripts est√©n en este orden:</p>
            
            <pre class="bg-black text-yellow-400 p-4 rounded text-xs overflow-x-auto"><code>&lt;!-- 1. PRIMERO: Cargar las reglas --&gt;
&lt;script src="./rules/chatbot-rules.js"&gt;&lt;/script&gt;

&lt;!-- 2. SEGUNDO: Script principal del chatbot --&gt;
&lt;script&gt;
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîç Verificando carga de reglas al iniciar...');
    
    // Verificar que las reglas se cargaron
    if (window.responses && Object.keys(window.responses).length > 0) {
        console.log(`‚úÖ Reglas cargadas: ${Object.keys(window.responses).length} reglas`);
    } else {
        console.error('‚ùå ERROR: No se cargaron las reglas!');
        console.log('üîß Intentando cargar reglas manualmente...');
        loadRulesManually();
    }
    
    // ... resto de tu c√≥digo del chatbot
});

// Funci√≥n de carga manual como fallback
function loadRulesManually() {
    const script = document.createElement('script');
    script.src = './rules/chatbot-rules.js';
    script.onload = function() {
        console.log('‚úÖ Reglas cargadas manualmente');
    };
    script.onerror = function() {
        console.error('‚ùå Error cargando reglas manualmente');
    };
    document.head.appendChild(script);
}
&lt;/script&gt;</code></pre>
        </div>

        <!-- Soluci√≥n 3: Funci√≥n handleMessage Mejorada -->
        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-6">
            <h2 class="text-xl font-semibold text-purple-800 mb-3">üîß Soluci√≥n 3: Funci√≥n handleMessage Mejorada</h2>
            <p class="text-purple-700 mb-3">Reemplaza tu funci√≥n <code>handleMessage()</code> con esta versi√≥n mejorada:</p>
            
            <pre class="bg-black text-purple-400 p-4 rounded text-xs overflow-x-auto"><code>async function handleMessage() {
    const input = document.getElementById('user-input');
    const text = input.value.trim();
    const lowerText = text.toLowerCase();
    
    if (!text) return;
    
    addMessage('user', text);
    input.value = '';
    
    let response = null;

    // 1. VERIFICAR CARGA DE REGLAS
    console.log('üîç Verificando disponibilidad de reglas...');
    console.log('window.responses existe:', !!window.responses);
    console.log('window.searchRules existe:', !!window.searchRules);
    
    if (window.responses) {
        console.log(`üìä Reglas disponibles: ${Object.keys(window.responses).length}`);
    }

    // 2. BUSCAR EN REGLAS LOCALES CON MEJOR LOGGING
    if (window.responses && Object.keys(window.responses).length > 0) {
        console.log(`üîç Buscando "${text}" en ${Object.keys(window.responses).length} reglas...`);
        
        // Usar la funci√≥n de b√∫squeda si est√° disponible
        if (window.searchRules) {
            response = window.searchRules(text);
        } else {
            // B√∫squeda manual como fallback
            const allRules = Object.values(window.responses);
            for (const rule of allRules) {
                if (rule && rule.keywords) {
                    for (const keyword of rule.keywords) {
                        const cleanedKeyword = keyword.replace(/\*/g, '');
                        if (lowerText.includes(cleanedKeyword)) {
                            response = rule.response;
                            console.log(`‚úÖ Regla encontrada: ${cleanedKeyword}`);
                            break;
                        }
                    }
                }
                if (response) break;
            }
        }
    } else {
        console.warn('‚ö†Ô∏è No hay reglas disponibles - intentando recargar...');
        
        // Intentar recargar reglas
        if (window.verifyRulesLoaded) {
            window.verifyRulesLoaded();
        }
        
        // Mostrar mensaje al usuario
        addMessage('bot', '‚ö†Ô∏è Estoy teniendo problemas para acceder a mi base de conocimiento local. Consultar√© con mi IA...');
    }
    
    // 3. SI HAY RESPUESTA LOCAL, USARLA
    if (response) {
        console.log('‚úÖ Usando respuesta de reglas locales');
        setTimeout(() => addMessage('bot', response), 500);
        return;
    }

    // 4. SI NO HAY RESPUESTA LOCAL, USAR IA
    console.log('ü§ñ No se encontr√≥ respuesta local, consultando IA...');
    addTypingIndicator();
    
    try {
        const systemPrompt = window.systemPrompt || 
            'Eres un asistente virtual de la oficina OS10 Coquimbo de Carabineros de Chile.';
        
        const contextualPrompt = `${systemPrompt}

CONTEXTO: El usuario pregunta "${text}" y no encontr√© respuesta en mi base de conocimiento local.

IMPORTANTE: Como soy un asistente de OS10 Coquimbo, debo responder sobre:
- Tr√°mites de seguridad privada
- Credenciales de guardias
- Directivas de funcionamiento  
- Cursos y capacitaciones
- Leyes y decretos de seguridad privada
- Informaci√≥n de contacto de la oficina

Responde de manera profesional, concisa y √∫til.`;

        const geminiPayload = {
            contents: [{ parts: [{ text: contextualPrompt }] }],
            safetySettings: [
                { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }
            ]
        };

        const apiResponse = await fetch('/api/gemini', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(geminiPayload),
        });

        removeTypingIndicator();

        if (!apiResponse.ok) {
            throw new Error(`Error API: ${apiResponse.status}`);
        }

        const data = await apiResponse.json();
        const aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || 
                          "No pude procesar tu consulta. Intenta reformular tu pregunta.";
        
        addMessage('bot', aiResponse);

    } catch (error) {
        console.error('üí• Error en consulta IA:', error);
        removeTypingIndicator();
        
        // Mensaje de error amigable
        addMessage('bot', 'Hubo un problema temporal. Por favor, intenta de nuevo o contacta directamente a la oficina OS10 Coquimbo: üìû 512651024');
    }
}</code></pre>
        </div>

        <!-- Verificaci√≥n Final -->
        <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4">
            <h2 class="text-xl font-semibold text-indigo-800 mb-3">üéØ Lista de Verificaci√≥n Final</h2>
            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <h3 class="font-semibold mb-2">üìÅ Estructura de Archivos:</h3>
                    <ul class="text-sm space-y-1">
                        <li>‚òê <code>rules/chatbot-rules.js</code> existe</li>
                        <li>‚òê Archivo inicia con <code>const responses = {</code></li>
                        <li>‚òê Termina con <code>window.responses = responses;</code></li>
                        <li>‚òê No hay errores de sintaxis JavaScript</li>
                    </ul>
                </div>
                <div>
                    <h3 class="font-semibold mb-2">üîß En el HTML:</h3>
                    <ul class="text-sm space-y-1">
                        <li>‚òê Script de reglas se carga ANTES que el principal</li>
                        <li>‚òê Funci√≥n <code>handleMessage()</code> actualizada</li>
                        <li>‚òê Console.log muestra reglas cargadas</li>
                        <li>‚òê Variables <code>window.responses</code> accesibles</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        function checkRulesLoading() {
            const output = document.getElementById('diagnostic-output');
            output.textContent = 'üîç Verificando carga de reglas...\n\n';
            
            // Simular carga de reglas para diagn√≥stico
            const mockRules = {
                'rule_1': { keywords: ["test"], response: "test response" },
                'rule_2': { keywords: ["hola"], response: "hola response" }
            };
            
            window.testResponses = mockRules;
            
            setTimeout(() => {
                if (window.testResponses) {
                    output.textContent += '‚úÖ √âXITO: Las reglas se pueden cargar correctamente\n';
                    output.textContent += `üìä Reglas de prueba: ${Object.keys(window.testResponses).length}\n`;
                    output.textContent += 'üîß Problema: Tu archivo rules/chatbot-rules.js no sigue la estructura correcta\n\n';
                    output.textContent += 'üí° SOLUCI√ìN:\n';
                    output.textContent += '1. Verificar que el archivo termine con: window.responses = responses;\n';
                    output.textContent += '2. Verificar que no haya errores de sintaxis JavaScript\n';
                    output.textContent += '3. Usar la estructura del archivo corregido de arriba\n';
                } else {
                    output.textContent += '‚ùå ERROR: Problema fundamental con JavaScript\n';
                }
            }, 1000);
        }

        function testRulesStructure() {
            const output = document.getElementById('diagnostic-output');
            output.textContent = 'üîç Probando estructura de reglas...\n\n';
            
            // Probar estructura correcta
            const testStructure = `
// Estructura correcta esperada:
const responses = {
    'rule_1': { 
        keywords: ["palabra1", "palabra2"], 
        response: "respuesta aqu√≠" 
    }
};
window.responses = responses;
            `;
            
            output.textContent += 'üìã Estructura esperada:\n';
            output.textContent += testStructure;
            output.textContent += '\n\n‚úÖ VERIFICACIONES:\n';
            output.textContent += '‚òê Archivo debe empezar con: const responses = {\n';
            output.textContent += '‚òê Cada regla tiene keywords y response\n';
            output.textContent += '‚òê Archivo debe terminar con: window.responses = responses;\n';
            output.textContent += '‚òê No debe haber errores de sintaxis JavaScript\n';
        }

        function simulateRulesSearch() {
            const output = document.getElementById('diagnostic-output');
            output.textContent = 'üîé Simulando b√∫squeda en reglas...\n\n';
            
            // Simular reglas de ejemplo
            const exampleRules = {
                'rule_1': { keywords: ["hola", "saludos"], response: "¬°Hola! ¬øEn qu√© puedo ayudarte?" },
                'rule_2': { keywords: ["credencial", "tramitar"], response: "Para tramitar credencial necesitas..." },
                'rule_3': { keywords: ["curso", "capacitacion"], response: "Los cursos de capacitaci√≥n..." }
            };
            
            const testQueries = ["hola", "necesito credencial", "donde hago curso", "informaci√≥n"];
            
            output.textContent += 'üìù Probando b√∫squedas:\n\n';
            
            testQueries.forEach(query => {
                let found = false;
                let matchedRule = null;
                
                for (const [ruleId, rule] of Object.entries(exampleRules)) {
                    for (const keyword of rule.keywords) {
                        if (query.toLowerCase().includes(keyword)) {
                            found = true;
                            matchedRule = ruleId;
                            break;
                        }
                    }
                    if (found) break;
                }
                
                if (found) {
                    output.textContent += `‚úÖ "${query}" ‚Üí Encontrada en ${matchedRule}\n`;
                } else {
                    output.textContent += `‚ùå "${query}" ‚Üí No encontrada (consultar√≠a IA)\n`;
                }
            });
            
            output.textContent += '\nüí° Tu sistema deber√≠a funcionar igual con tus reglas reales\n';
        }

        function downloadCorrectRulesFile() {
            const output = document.getElementById('diagnostic-output');
            output.textContent = 'üì• Generando archivo corregido...\n\n';
            
            const correctedFileContent = `// ===== ARCHIVO CORREGIDO: rules/chatbot-rules.js =====
console.log('üîÑ Cargando base de datos de reglas OS10...');

const responses = {
    'rule_1': { 
        keywords: ["*bots*","*tienes algun bots*","*bots de ciberseguridad*"], 
        response: 'ü§ñ *Bots con IA avanzada:* \\n *1 Bot Seguridad Privada* \\n dal5.short.gy/SePriv' 
    },
    'rule_2': { 
        keywords: ["infracciones", "sanciones guardias", "multas guardias"], 
        response: 'Infracciones de Guardias (Decreto Supremo N¬∞ 93):\\n\\n*Guardia sin curso OS10:*\\nInfringe el *art√≠culo 13*.' 
    },
    // AQU√ç AGREGAR TODAS TUS REGLAS...
    'rule_350': { 
        keywords: ["*donde puedo hacer el curso*","*empresa capacitadora*"], 
        response: 'ü§ñüßôüèº‚Äç‚ôÇÔ∏è‚úÖ Estas son algunas empresas de aqui de la region...' 
    }
};

const systemPrompt = \`Eres un asistente virtual y funcionario de la oficina de Seguridad Privada OS10 de Carabineros en Coquimbo, Chile.\`;

// Hacer variables globalmente accesibles
window.responses = responses;
window.systemPrompt = systemPrompt;

// Verificaci√≥n
console.log(\`‚úÖ \${Object.keys(responses).length} reglas cargadas correctamente\`);
`;
            
            // Crear y descargar archivo
            const blob = new Blob([correctedFileContent], { type: 'text/javascript' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'chatbot-rules-corregido.js';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            output.textContent += '‚úÖ Archivo descargado: chatbot-rules-corregido.js\n';
            output.textContent += 'üìÅ Reemplaza tu archivo actual con este\n';
            output.textContent += 'üîß Agrega todas tus reglas en el formato mostrado\n';
        }
    </script>
</body>
</html>
