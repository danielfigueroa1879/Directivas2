<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solución: Carga de Reglas Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-6">
        <h1 class="text-3xl font-bold text-blue-600 mb-6">🔧 Solución: Carga de Base de Datos de Reglas</h1>
        
        <!-- Diagnóstico del Problema -->
        <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
            <h2 class="text-xl font-semibold text-red-800 mb-3">🔍 Problema Identificado</h2>
            <p class="text-red-700 mb-2">El archivo <code>rules/chatbot-rules.js</code> no se está cargando correctamente.</p>
            <p class="text-sm text-red-600">Esto puede deberse a:</p>
            <ul class="list-disc pl-5 text-sm text-red-600 mt-2">
                <li>Estructura del archivo JavaScript incorrecta</li>
                <li>Orden de carga de scripts</li>
                <li>Problemas de ruta relativa</li>
                <li>Variables globales no accesibles</li>
            </ul>
        </div>

        <!-- Herramienta de Diagnóstico en Vivo -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <h2 class="text-xl font-semibold text-blue-800 mb-3">🧪 Herramienta de Diagnóstico</h2>
            <div class="space-y-3">
                <button onclick="checkRulesLoading()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    📋 Verificar Carga de Reglas
                </button>
                <button onclick="testRulesStructure()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    🔍 Probar Estructura de Reglas
                </button>
                <button onclick="simulateRulesSearch()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                    🔎 Simular Búsqueda en Reglas
                </button>
                <button onclick="downloadCorrectRulesFile()" class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600">
                    📥 Generar Archivo Corregido
                </button>
            </div>
            <div id="diagnostic-output" class="mt-4 p-3 bg-gray-50 rounded min-h-[150px] font-mono text-sm whitespace-pre-wrap">
Haz clic en los botones para ejecutar diagnósticos...
            </div>
        </div>

        <!-- Solución 1: Estructura Correcta del Archivo -->
        <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
            <h2 class="text-xl font-semibold text-green-800 mb-3">✅ Solución 1: Estructura Correcta de chatbot-rules.js</h2>
            <p class="text-green-700 mb-3">Asegúrate de que tu archivo <code>rules/chatbot-rules.js</code> tenga esta estructura:</p>
            
            <pre class="bg-black text-green-400 p-4 rounded text-xs overflow-x-auto"><code>// ===== ARCHIVO: rules/chatbot-rules.js =====

// Sistema de Respuestas del Chatbot OS10 Coquimbo
console.log('🔄 Cargando base de datos de reglas OS10...');

// Objeto principal de respuestas
const responses = {
    'rule_1': { 
        keywords: ["*bots*","*tienes algun bots*","*bots de ciberseguridad*"], 
        response: '🤖 *Bots con IA avanzada:* \n *1 Bot Seguridad Privada* \n dal5.short.gy/SePriv *2 Bot de Ciberseguridad 2024* \n dal5.short.gy/Cib' 
    },
    'rule_2': { 
        keywords: ["infracciones", "sanciones guardias"], 
        response: 'Infracciones de Guardias (Decreto Supremo N° 93)...' 
    },
    // ... todas tus reglas aquí
    'rule_350': { 
        keywords: ["*donde puedo hacer el curso*","*empresa capacitadora*"], 
        response: '🤖🧙🏼‍♂️✅ Estas son algunas empresas de aqui de la region...' 
    },
    'rule_351': { 
        keywords: ["*quien es tu creador*","*quien te creo*"], 
        response: '🤖🧙🏼‍♂️✅ Mi creador es el\n*Ingeniero en Informática y Ciberseguridad \nDaniel Elías Figueroa Chacama*' 
    }
};

// Prompt del sistema
const systemPrompt = `Eres un asistente virtual y funcionario de la oficina de Seguridad Privada OS10 de Carabineros en Coquimbo, Chile. Tu principal objetivo es ayudar a los usuarios con sus trámites y consultas, responde como si fueras un experto en Seguridad Privada, profesional.

Tus reglas principales son:
1. **Asume tu Rol:** Responde siempre como si fueras un miembro del equipo de la oficina OS10 Coquimbo.
2. **Prioridad a los documentos:** Tu máxima prioridad es buscar y entregar primero cualquier documento, guía o PDF.
3. **Respuestas cortas y reales:** Sé conciso y factual. No inventes respuestas.
4. **Formato claro:** Usa Markdown para dar formato.
5. **OS10 COQUIMBO:** Oficina ubicada en Calle Cienfuegos N°180, La Serena, fono: 51 2 651024.
6. **Infracciones principales:** sin curso os10 art. 13, sin directiva art. 15, sin credencial art 18, etc.
7. **Nueva Ley:** Ley 21.659 entra en vigencia el 28-NOV-2025.
8. **Infracciones ordenadas:** Siempre enumerar con negrillas.
9. **Resumen de ley:** Proporcionar información detallada cuando se solicite.`;

// Función de verificación de carga
function verifyRulesLoaded() {
    console.log('✅ Verificando carga de reglas...');
    console.log(`📊 Total de reglas cargadas: ${Object.keys(responses).length}`);
    console.log('📋 Primeras 5 reglas:', Object.keys(responses).slice(0, 5));
    return {
        loaded: true,
        count: Object.keys(responses).length,
        sample: Object.keys(responses).slice(0, 5)
    };
}

// Función para buscar reglas
function searchRules(userInput) {
    const lowerInput = userInput.toLowerCase();
    console.log(`🔍 Buscando reglas para: "${userInput}"`);
    
    for (const [ruleId, rule] of Object.entries(responses)) {
        if (rule && rule.keywords) {
            for (const keyword of rule.keywords) {
                const cleanKeyword = keyword.replace(/\*/g, '');
                if (lowerInput.includes(cleanKeyword)) {
                    console.log(`✅ Regla encontrada: ${ruleId} -> ${cleanKeyword}`);
                    return rule.response;
                }
            }
        }
    }
    console.log('❌ No se encontró regla matching');
    return null;
}

// Hacer las variables globalmente accesibles
window.responses = responses;
window.systemPrompt = systemPrompt;
window.verifyRulesLoaded = verifyRulesLoaded;
window.searchRules = searchRules;

// Verificación automática al cargar
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 DOM cargado, verificando reglas...');
    const verification = verifyRulesLoaded();
    console.log('📋 Resultado verificación:', verification);
});

console.log('✅ Base de datos de reglas OS10 cargada correctamente');
console.log(`📊 ${Object.keys(responses).length} reglas disponibles`);</code></pre>
        </div>

        <!-- Solución 2: Orden de Scripts en HTML -->
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
            <h2 class="text-xl font-semibold text-yellow-800 mb-3">⚡ Solución 2: Orden Correcto de Scripts en HTML</h2>
            <p class="text-yellow-700 mb-3">En tu archivo HTML, asegúrate de que los scripts estén en este orden:</p>
            
            <pre class="bg-black text-yellow-400 p-4 rounded text-xs overflow-x-auto"><code>&lt;!-- 1. PRIMERO: Cargar las reglas --&gt;
&lt;script src="./rules/chatbot-rules.js"&gt;&lt;/script&gt;

&lt;!-- 2. SEGUNDO: Script principal del chatbot --&gt;
&lt;script&gt;
document.addEventListener('DOMContentLoaded', function() {
    console.log('🔍 Verificando carga de reglas al iniciar...');
    
    // Verificar que las reglas se cargaron
    if (window.responses && Object.keys(window.responses).length > 0) {
        console.log(`✅ Reglas cargadas: ${Object.keys(window.responses).length} reglas`);
    } else {
        console.error('❌ ERROR: No se cargaron las reglas!');
        console.log('🔧 Intentando cargar reglas manualmente...');
        loadRulesManually();
    }
    
    // ... resto de tu código del chatbot
});

// Función de carga manual como fallback
function loadRulesManually() {
    const script = document.createElement('script');
    script.src = './rules/chatbot-rules.js';
    script.onload = function() {
        console.log('✅ Reglas cargadas manualmente');
    };
    script.onerror = function() {
        console.error('❌ Error cargando reglas manualmente');
    };
    document.head.appendChild(script);
}
&lt;/script&gt;</code></pre>
        </div>

        <!-- Solución 3: Función handleMessage Mejorada -->
        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-6">
            <h2 class="text-xl font-semibold text-purple-800 mb-3">🔧 Solución 3: Función handleMessage Mejorada</h2>
            <p class="text-purple-700 mb-3">Reemplaza tu función <code>handleMessage()</code> con esta versión mejorada:</p>
            
            <pre class="bg-black text-purple-400 p-4 rounded text-xs overflow-x-auto"><code>async function handleMessage() {
    const input = document.getElementById('user-input');
    const text = input.value.trim();
    const lowerText = text.toLowerCase();
    
    if (!text) return;
    
    addMessage('user', text);
    input.value = '';
    
    let response = null;

    // 1. VERIFICAR CARGA DE REGLAS
    console.log('🔍 Verificando disponibilidad de reglas...');
    console.log('window.responses existe:', !!window.responses);
    console.log('window.searchRules existe:', !!window.searchRules);
    
    if (window.responses) {
        console.log(`📊 Reglas disponibles: ${Object.keys(window.responses).length}`);
    }

    // 2. BUSCAR EN REGLAS LOCALES CON MEJOR LOGGING
    if (window.responses && Object.keys(window.responses).length > 0) {
        console.log(`🔍 Buscando "${text}" en ${Object.keys(window.responses).length} reglas...`);
        
        // Usar la función de búsqueda si está disponible
        if (window.searchRules) {
            response = window.searchRules(text);
        } else {
            // Búsqueda manual como fallback
            const allRules = Object.values(window.responses);
            for (const rule of allRules) {
                if (rule && rule.keywords) {
                    for (const keyword of rule.keywords) {
                        const cleanedKeyword = keyword.replace(/\*/g, '');
                        if (lowerText.includes(cleanedKeyword)) {
                            response = rule.response;
                            console.log(`✅ Regla encontrada: ${cleanedKeyword}`);
                            break;
                        }
                    }
                }
                if (response) break;
            }
        }
    } else {
        console.warn('⚠️ No hay reglas disponibles - intentando recargar...');
        
        // Intentar recargar reglas
        if (window.verifyRulesLoaded) {
            window.verifyRulesLoaded();
        }
        
        // Mostrar mensaje al usuario
        addMessage('bot', '⚠️ Estoy teniendo problemas para acceder a mi base de conocimiento local. Consultaré con mi IA...');
    }
    
    // 3. SI HAY RESPUESTA LOCAL, USARLA
    if (response) {
        console.log('✅ Usando respuesta de reglas locales');
        setTimeout(() => addMessage('bot', response), 500);
        return;
    }

    // 4. SI NO HAY RESPUESTA LOCAL, USAR IA
    console.log('🤖 No se encontró respuesta local, consultando IA...');
    addTypingIndicator();
    
    try {
        const systemPrompt = window.systemPrompt || 
            'Eres un asistente virtual de la oficina OS10 Coquimbo de Carabineros de Chile.';
        
        const contextualPrompt = `${systemPrompt}

CONTEXTO: El usuario pregunta "${text}" y no encontré respuesta en mi base de conocimiento local.

IMPORTANTE: Como soy un asistente de OS10 Coquimbo, debo responder sobre:
- Trámites de seguridad privada
- Credenciales de guardias
- Directivas de funcionamiento  
- Cursos y capacitaciones
- Leyes y decretos de seguridad privada
- Información de contacto de la oficina

Responde de manera profesional, concisa y útil.`;

        const geminiPayload = {
            contents: [{ parts: [{ text: contextualPrompt }] }],
            safetySettings: [
                { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }
            ]
        };

        const apiResponse = await fetch('/api/gemini', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(geminiPayload),
        });

        removeTypingIndicator();

        if (!apiResponse.ok) {
            throw new Error(`Error API: ${apiResponse.status}`);
        }

        const data = await apiResponse.json();
        const aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || 
                          "No pude procesar tu consulta. Intenta reformular tu pregunta.";
        
        addMessage('bot', aiResponse);

    } catch (error) {
        console.error('💥 Error en consulta IA:', error);
        removeTypingIndicator();
        
        // Mensaje de error amigable
        addMessage('bot', 'Hubo un problema temporal. Por favor, intenta de nuevo o contacta directamente a la oficina OS10 Coquimbo: 📞 512651024');
    }
}</code></pre>
        </div>

        <!-- Verificación Final -->
        <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4">
            <h2 class="text-xl font-semibold text-indigo-800 mb-3">🎯 Lista de Verificación Final</h2>
            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <h3 class="font-semibold mb-2">📁 Estructura de Archivos:</h3>
                    <ul class="text-sm space-y-1">
                        <li>☐ <code>rules/chatbot-rules.js</code> existe</li>
                        <li>☐ Archivo inicia con <code>const responses = {</code></li>
                        <li>☐ Termina con <code>window.responses = responses;</code></li>
                        <li>☐ No hay errores de sintaxis JavaScript</li>
                    </ul>
                </div>
                <div>
                    <h3 class="font-semibold mb-2">🔧 En el HTML:</h3>
                    <ul class="text-sm space-y-1">
                        <li>☐ Script de reglas se carga ANTES que el principal</li>
                        <li>☐ Función <code>handleMessage()</code> actualizada</li>
                        <li>☐ Console.log muestra reglas cargadas</li>
                        <li>☐ Variables <code>window.responses</code> accesibles</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        function checkRulesLoading() {
            const output = document.getElementById('diagnostic-output');
            output.textContent = '🔍 Verificando carga de reglas...\n\n';
            
            // Simular carga de reglas para diagnóstico
            const mockRules = {
                'rule_1': { keywords: ["test"], response: "test response" },
                'rule_2': { keywords: ["hola"], response: "hola response" }
            };
            
            window.testResponses = mockRules;
            
            setTimeout(() => {
                if (window.testResponses) {
                    output.textContent += '✅ ÉXITO: Las reglas se pueden cargar correctamente\n';
                    output.textContent += `📊 Reglas de prueba: ${Object.keys(window.testResponses).length}\n`;
                    output.textContent += '🔧 Problema: Tu archivo rules/chatbot-rules.js no sigue la estructura correcta\n\n';
                    output.textContent += '💡 SOLUCIÓN:\n';
                    output.textContent += '1. Verificar que el archivo termine con: window.responses = responses;\n';
                    output.textContent += '2. Verificar que no haya errores de sintaxis JavaScript\n';
                    output.textContent += '3. Usar la estructura del archivo corregido de arriba\n';
                } else {
                    output.textContent += '❌ ERROR: Problema fundamental con JavaScript\n';
                }
            }, 1000);
        }

        function testRulesStructure() {
            const output = document.getElementById('diagnostic-output');
            output.textContent = '🔍 Probando estructura de reglas...\n\n';
            
            // Probar estructura correcta
            const testStructure = `
// Estructura correcta esperada:
const responses = {
    'rule_1': { 
        keywords: ["palabra1", "palabra2"], 
        response: "respuesta aquí" 
    }
};
window.responses = responses;
            `;
            
            output.textContent += '📋 Estructura esperada:\n';
            output.textContent += testStructure;
            output.textContent += '\n\n✅ VERIFICACIONES:\n';
            output.textContent += '☐ Archivo debe empezar con: const responses = {\n';
            output.textContent += '☐ Cada regla tiene keywords y response\n';
            output.textContent += '☐ Archivo debe terminar con: window.responses = responses;\n';
            output.textContent += '☐ No debe haber errores de sintaxis JavaScript\n';
        }

        function simulateRulesSearch() {
            const output = document.getElementById('diagnostic-output');
            output.textContent = '🔎 Simulando búsqueda en reglas...\n\n';
            
            // Simular reglas de ejemplo
            const exampleRules = {
                'rule_1': { keywords: ["hola", "saludos"], response: "¡Hola! ¿En qué puedo ayudarte?" },
                'rule_2': { keywords: ["credencial", "tramitar"], response: "Para tramitar credencial necesitas..." },
                'rule_3': { keywords: ["curso", "capacitacion"], response: "Los cursos de capacitación..." }
            };
            
            const testQueries = ["hola", "necesito credencial", "donde hago curso", "información"];
            
            output.textContent += '📝 Probando búsquedas:\n\n';
            
            testQueries.forEach(query => {
                let found = false;
                let matchedRule = null;
                
                for (const [ruleId, rule] of Object.entries(exampleRules)) {
                    for (const keyword of rule.keywords) {
                        if (query.toLowerCase().includes(keyword)) {
                            found = true;
                            matchedRule = ruleId;
                            break;
                        }
                    }
                    if (found) break;
                }
                
                if (found) {
                    output.textContent += `✅ "${query}" → Encontrada en ${matchedRule}\n`;
                } else {
                    output.textContent += `❌ "${query}" → No encontrada (consultaría IA)\n`;
                }
            });
            
            output.textContent += '\n💡 Tu sistema debería funcionar igual con tus reglas reales\n';
        }

        function downloadCorrectRulesFile() {
            const output = document.getElementById('diagnostic-output');
            output.textContent = '📥 Generando archivo corregido...\n\n';
            
            const correctedFileContent = `// ===== ARCHIVO CORREGIDO: rules/chatbot-rules.js =====
console.log('🔄 Cargando base de datos de reglas OS10...');

const responses = {
    'rule_1': { 
        keywords: ["*bots*","*tienes algun bots*","*bots de ciberseguridad*"], 
        response: '🤖 *Bots con IA avanzada:* \\n *1 Bot Seguridad Privada* \\n dal5.short.gy/SePriv' 
    },
    'rule_2': { 
        keywords: ["infracciones", "sanciones guardias", "multas guardias"], 
        response: 'Infracciones de Guardias (Decreto Supremo N° 93):\\n\\n*Guardia sin curso OS10:*\\nInfringe el *artículo 13*.' 
    },
    // AQUÍ AGREGAR TODAS TUS REGLAS...
    'rule_350': { 
        keywords: ["*donde puedo hacer el curso*","*empresa capacitadora*"], 
        response: '🤖🧙🏼‍♂️✅ Estas son algunas empresas de aqui de la region...' 
    }
};

const systemPrompt = \`Eres un asistente virtual y funcionario de la oficina de Seguridad Privada OS10 de Carabineros en Coquimbo, Chile.\`;

// Hacer variables globalmente accesibles
window.responses = responses;
window.systemPrompt = systemPrompt;

// Verificación
console.log(\`✅ \${Object.keys(responses).length} reglas cargadas correctamente\`);
`;
            
            // Crear y descargar archivo
            const blob = new Blob([correctedFileContent], { type: 'text/javascript' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'chatbot-rules-corregido.js';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            output.textContent += '✅ Archivo descargado: chatbot-rules-corregido.js\n';
            output.textContent += '📁 Reemplaza tu archivo actual con este\n';
            output.textContent += '🔧 Agrega todas tus reglas en el formato mostrado\n';
        }
    </script>
</body>
</html>
