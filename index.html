<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    
    <!-- Meta Tags Principales y de PWA -->
    <title>Directivas de Funcionamiento OS10</title>
    <meta name="description" content="Requisitos e información para Directivas de Funcionamiento de Seguridad Privada OS10.">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ffffff"/>
    <meta name="application-name" content="Directivas OS10">
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Configuración para iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Directivas OS10">

    <!-- Favicons y Iconos Estándar -->
    <link rel="icon" href="assets/images/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="assets/images/icon-192x192.png">
    
    <!-- Dependencias y Estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    
    <!-- IMPORTANTE: Ahora index.html carga también los estilos de credenciales.css -->
    <link rel="stylesheet" href="assets/css/credenciales.css">

    <!-- Estilos personalizados -->
    <style>
        body { 
            font-family: 'Poppins', sans-serif; 
            background-image: url('assets/images/101.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        .card-container { 
            /* Ancho por defecto para pantallas <= 374px (como 320px) */
            width: 99% !important; /* ANCHO PARA MÓVILES MUY PEQUEÑOS (< 375px) - ¡FORZADO! */
            max-width: 750px; /* ANCHO MÁXIMO PARA PANTALLAS GRANDES */
            margin: 0.5rem auto; 
            padding: 1.5rem; 
        }

        /* Ajuste para pantallas pequeñas (entre 375px y 767px) */
        @media (min-width: 375px) and (max-width: 767px) {
            .card-container {
                width: 99% !important; /* ANCHO PARA MÓVILES ESTÁNDAR - ¡FORZADO! */
            }
        }
        /* Ajuste para pantallas MÁS GRANDES que móviles (tablets y desktop) */
        @media (min-width: 768px) {
            .card-container {
                width: 99% !important; /* Ajuste para tablets y desktop - ¡FORZADO! */
            }
        }

        .logo-os10-container { 
            position: absolute;
            top: 1.5rem;
            left: 1.5rem;
            height: 60px;
            z-index: 10;
        }
        .section-card { 
            border-left-width: 4px; 
            padding: 1rem; 
            border-radius: 0.5rem; 
        }
        
        .voice-button { transition: all 0.3s ease; }
        .voice-button:hover { transform: scale(1.05); }
        .voice-button:active { transform: scale(0.95); }
        .voice-button.animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        
        .response-button { transition: all 0.2s ease; }
        .response-button:hover { transform: translateX(4px); }

        /* Estilos Chatbot */
        #chat-widget-container { 
            position: fixed; 
            bottom: 6rem;
            right: 1.5rem;
            z-index: 1000; 
            display: flex; 
            flex-direction: column; 
            align-items: flex-end;
        }
        #chat-popup { 
            width: 450px; 
            height: 600px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); 
        }
        #chat-toggle-button { 
            width: 80px;
            height: 80px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); 
        }
        .chat-messages-container { 
            scroll-behavior: smooth; 
        }
        .typing-indicator {
            display: flex;
            align-items: center;
            padding: 8px 12px;
        }
        .typing-indicator span {
            height: 8px;
            width: 8px;
            margin: 0 2px;
            background-color: #9ca3af;
            border-radius: 50%;
            display: inline-block;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }

        /* Ajuste para pantallas más grandes (PC) */
        @media (min-width: 1024px) {
            #chat-widget-container {
                right: 29rem; 
            }
            #chat-toggle-button {
                width: 90px;
                height: 90px;
            }
        }
       /* Ajustes para pantallas medianas (tablets) */
       @media (min-width: 768px) and (max-width: 1023px) {
            #chat-widget-container {
                right: 29rem; 
            }
        }
        
        /* Ajuste para pantallas pequeñas (Celular) - esta regla ya no necesita el width porque se define arriba */
        @media (max-width: 767px) {
            #chat-popup {
                width: calc(100vw - 3rem);
            }
        }
    </style>
</head>
<body class="pt-10"> <!-- AQUÍ SE AÑADE EL PADDING-TOP -->
    <!-- Banner informativo fijo -->
    <div id="banner" class="fixed top-0 left-0 right-0 z-[1100] bg-white/50 backdrop-blur-sm border-b border-gray-200/50 h-10 flex items-center justify-center text-sm text-gray-700 shadow-sm">
        <span class="font-medium">O.S.10 COQUIMBO&nbsp;&nbsp;</span>
        <span> | </span>
        <div class="flex items-center text-xs ml-2">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
            </svg>
            <span>Visitas: <span id="visit-counter" class="font-bold">--</span></span>
        </div>
    </div>

    <!-- Contenedor principal de la página -->
    <div class="card-container bg-white/90 backdrop-blur-sm rounded-xl shadow-lg space-y-6 relative p-6">
        <!-- Logo dentro del contenedor (este logo es el que se mantiene) -->
        <a href="https://www.zosepcar.cl/OS10.php" target="_blank" aria-label="Visitar página de ZOSEPCAR" class="logo-os10-container">
            <img src="assets/images/logo-os10.png" alt="Logo OS10" class="h-full" loading="lazy">
        </a>
        
        <!-- Área donde se cargará el contenido dinámico (inicio o credenciales) -->
        <div id="dynamic-content-area">
            <!-- El contenido se inyectará aquí con JavaScript -->
        </div>

   </div>

    <!-- ===== CHATBOT FLOTANTE CON VOZ ===== -->
    <div id="chat-widget-container">
        <div id="chat-popup" class="hidden flex flex-col bg-white/95 backdrop-blur-lg border border-green-500/50 rounded-2xl">
            <!-- Header -->
            <header class="p-3 border-b border-green-500/30 flex items-center justify-between text-gray-800">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-full bg-white border-2 border-green-400/80 flex items-center justify-center flex-shrink-0 p-1">
                        <img src="assets/images/poli.png" alt="Bot Icon" class="h-full w-full object-contain">
                    </div>
                    <div>
                        <h1 class="text-base font-bold">Asistente OS10 🎤</h1>
                        <p class="text-xs text-gray-500">Con funciones de voz</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button id="speak-btn" class="voice-button bg-green-500 hover:bg-green-600 rounded-lg p-2 text-white" title="🔊 Leer último mensaje"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 0 0 1 0 14.14"/></svg></button>
                    <button id="chat-close-btn-internal" class="text-gray-500 hover:text-gray-800"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                </div>
            </header>
            <!-- contenedor de mensajes del chat -->
            <main id="chat-messages" class="chat-messages-container flex-1 p-4 overflow-y-auto"></main>
            <footer class="p-3 border-t border-green-500/30">
                <div class="mb-2 text-xs text-center text-gray-500"><span>Alt+V para micrófono</span></div>
                <div class="flex items-center space-x-2 bg-gray-200 rounded-xl p-2">
                    <button id="toggle-speak-btn" class="voice-button bg-yellow-500 hover:bg-yellow-600 rounded-lg p-2 text-white" title="Activar/Desactivar Auto-Lectura">
                        <!-- Speaker On Icon -->
                        <svg id="speaker-on-icon" class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 0 1 0 12.728M16.463 8.288a5.25 5.25 0 0 1 0 7.424M6.75 8.25l4.72-4.72a.75.75 0 0 1 1.28.53v15.88a.75.75 0 0 1-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 0 1 2.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75Z" />
                        </svg>
                        <!-- Speaker Off Icon (hidden by default) -->
                        <svg id="speaker-off-icon" class="w-5 h-5 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M17.25 9.75 19.5 12m0 0 2.25 2.25M19.5 12l-2.25 2.25M19.5 12l2.25-2.25M6.75 8.25l4.72-4.72a.75.75 0 0 1 1.28.53v15.88a.75.75 0 0 1-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 0 1 2.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75Z" />
                        </svg>
                    </button>
                    <button id="voice-btn" class="voice-button bg-blue-500 hover:bg-blue-600 rounded-lg p-2 text-white" title="🎤 Hablar"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="23"/><line x1="8" x2="16" y1="23" y2="23"/></svg></button>
                    <input type="text" id="user-input" placeholder="Escribe o usa el micrófono..." class="flex-1 w-full bg-transparent text-gray-800 placeholder-gray-500 focus:outline-none px-2 text-base">
                    <button id="send-button" class="flex-shrink-0 bg-green-500 hover:bg-green-600 transition-colors rounded-lg p-2 text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" /></svg></button>
                </div>
            </footer>
        </div>
        <button id="chat-toggle-button" class="bg-white rounded-2xl flex items-center justify-center p-1 mt-4" title="Abrir Asistente Virtual con Voz">
            <img src="assets/images/poli.png" alt="Icono del Chatbot" class="h-full w-full object-contain">
        </button>
    </div>
    <div id="chat-backdrop" class="hidden fixed inset-0 bg-black/60 z-40"></div>

    <!-- Scripts -->

<script>
function ajustarPadding() {
  const banner = document.getElementById('banner');
  const cardContainer = document.querySelector('.card-container'); // El contenedor principal de contenido

  if (!banner || !cardContainer) return;

  const altura = Math.ceil(banner.getBoundingClientRect().height);
  cardContainer.style.paddingTop = altura + 'px'; // Aplica el padding al contenedor principal
}

// Ajusta al cargar y cuando se redimensiona la ventana
window.addEventListener('load', ajustarPadding);
window.addEventListener('resize', ajustarPadding);
</script>

    <script type="module">
        // SCRIPT FIREBASE (Contador de visitas)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBB2AegLOQ-b6ZGI_cuPycSFJFuRsUlu5U",
          authDomain: "cuenta-946e2.firebaseapp.com",
          projectId: "cuenta-946e2",
          storageBucket: "cuenta-946e2.firebasestorage.app",
          messagingSenderId: "816979648502",
          appId: "1:816979648502:web:809beffeea8ba7968031d7",
          measurementId: "G-RX9KZSC0F4"
        };

        // Inicializar Firebase UNA SOLA VEZ
        let appInstance;
        let dbInstance;
        let authInstance;

        async function initializeFirebase() {
            if (!appInstance) {
                appInstance = initializeApp(firebaseConfig);
                dbInstance = getFirestore(appInstance);
                authInstance = getAuth(appInstance);
                console.log("Firebase inicializado.");
            }
        }
        
        // Hacer runCounter accesible globalmente
        window.runCounter = async function() {
            await initializeFirebase(); // Asegura que Firebase esté inicializado
            const counterSpan = document.getElementById('visit-counter'); // Contador en el banner principal

            try {
                // Intenta iniciar sesión anónimamente solo si aún no hay un usuario autenticado
                if (!authInstance.currentUser) {
                    await signInAnonymously(authInstance);
                }
                
                const counterRef = doc(dbInstance, `page-visits/${firebaseConfig.projectId}/visits/counter`);
                const newCount = await runTransaction(dbInstance, async (transaction) => {
                    const counterDoc = await transaction.get(counterRef);
                    let count = 1;
                    if (counterDoc.exists()) {
                        count = counterDoc.data().count + 1;
                        transaction.update(counterRef, { count: count });
                    } else {
                        transaction.set(counterRef, { count: count });
                    }
                    return count;
                });
                if (counterSpan) counterSpan.textContent = newCount.toLocaleString('es-CL');
            } catch (error) {
                console.error("ERROR: Falló el proceso del contador.", error);
                if (counterSpan) counterSpan.textContent = "Error";
            }
        };


    </script>
    
    <!-- Cargar las reglas desde el archivo externo -->
    <script src="./rules/chatbot-rules.js"></script>
    
    <!-- SCRIPT PRINCIPAL DEL CHATBOT y Lógica de Carga Dinámica -->
    <script type="module">
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar el contador al cargar la página principal
            window.runCounter(); 

            // FORZAR MODO CLARO SIEMPRE - ELIMINADO MODO OSCURO COMPLETAMENTE
            document.documentElement.classList.remove('dark');
            localStorage.setItem('theme', 'light');
            
            // --- Lógica del Chatbot ---
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const speechSynth = window.speechSynthesis;
            let recognition;
            let isListening = false;
            let availableVoices = [];
            let isAutoReadEnabled = true;
            
            // Cargar reglas desde el único archivo
            const allRules = Object.values(window.responses || {});
            const systemPrompt = window.systemPrompt || 'Eres un asistente de ayuda.'; 

            function loadVoices() {
                availableVoices = speechSynth.getVoices();
                if (availableVoices.length > 0) {
                     console.log("Voces cargadas.");
                }
            }

            loadVoices();
            if (speechSynth.onvoiceschanged !== undefined) {
                speechSynth.onvoiceschanged = loadVoices;
            }

            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.lang = 'es-CL';
                recognition.continuous = false;
                recognition.interimResults = false;
            } else {
                console.warn("El reconocimiento de voz no es compatible con este navegador.");
                document.getElementById('voice-btn').style.display = 'none';
            }

            function speakText(text) {
                const urlRegex = /(https?:\/\/[^\s]+)/g;
                const emojiRegex = /([\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2011-\u26FF]|\uD83E[\uDD10-\uDDFF])/g;
                const cleanText = text
                    .replace(urlRegex, '')
                    .replace(emojiRegex, '')
                    .replace(/<br>/g, '. ')
                    .replace(/<strong>/g, '')
                    .replace(/<\/strong>/g, '')
                    .replace(/\n/g, '. ')
                    .replace(/\*/g, '');
                
                if (!cleanText.trim() || !speechSynth) return;

                speechSynth.cancel();
                const utterance = new SpeechSynthesisUtterance(cleanText);

                // Seleccionar la mejor voz masculina
                let selectedVoice = null;
                if (availableVoices.length > 0) {
                    selectedVoice = availableVoices.find(voice => 
                        voice.name.toLowerCase().includes('diego') && voice.lang.startsWith('es')) ||
                        availableVoices.find(voice => 
                            (voice.name.toLowerCase().includes('jorge') || voice.name.toLowerCase().includes('carlos')) && voice.name.toLowerCase().includes('latina') && voice.lang.startsWith('es')) ||
                        availableVoices.find(voice => 
                            voice.lang.startsWith('es') && !voice.name.toLowerCase().match(/laura|helena|paulina|isabelle|sofia|camila|elena|isabel/i)) ||
                        availableVoices.find(voice => voice.lang.startsWith('es'));
                }

                if (selectedVoice) {
                    utterance.voice = selectedVoice;
                    console.log('🗣️ Usando voz:', selectedVoice.name);
                }

                utterance.lang = 'es-ES';
                utterance.rate = 1.3;  // Rápido y energético
                utterance.pitch = 0.6; // Masculino
                utterance.volume = 1.0; // Alto
                speechSynth.speak(utterance);
            }

            function toggleChat() {
                const popup = document.getElementById('chat-popup');
                const backdrop = document.getElementById('chat-backdrop');
                const button = document.getElementById('chat-toggle-button');
                
                const isHidden = popup.classList.contains('hidden');
                popup.classList.toggle('hidden');
                backdrop.classList.toggle('hidden');
                button.classList.toggle('hidden', isHidden);
            }

            function addMessage(sender, text, buttons = []) {
                const chatMessages = document.getElementById('chat-messages');
                const messageDiv = document.createElement('div');
                
                let content = '';
                if (sender === 'user') {
                    messageDiv.className = 'flex items-start space-x-2 mb-3 justify-end';
                    content = `<div class="bg-blue-500 text-white p-3 rounded-lg max-w-xs">${text}</div><div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-sm flex-shrink-0">U</div>`;
                } else {
                    messageDiv.className = 'flex items-start space-x-2 mb-1';
                    const urlRegex = /(\b(?:https?:\/\/)?[a-zA-Z0-9-.]+\.[a-zA-Z]{2,}(?:\/[a-zA-Z0-9\-_./?=&%#]*)?)/g;
                    let formattedText = text.replace(/\n/g, '<br>').replace(/\*(.*?)\*/g, '<strong>$1</strong>');
                    formattedText = formattedText.replace(urlRegex, (url) => {
                        const cleanedUrl = url.replace(/[.,!?)\]]*$/, '');
                        let fullUrl = cleanedUrl.startsWith('http') ? cleanedUrl : 'https://' + cleanedUrl;
                        let buttonText = "🔗 Abrir";
                        if (/(dal5\.short\.gy|os10\.short\.gy|d6\.short\.gy)/.test(cleanedUrl)) buttonText = "📄 Descargar";
                        else if (cleanedUrl.includes('bcn.cl')) buttonText = "⚖️ Ver ley";
                        else if (cleanedUrl.includes('zosepcar.cl')) buttonText = "🏢 Ver OS10";
                        return ` <button onclick="window.open('${fullUrl}', '_blank')" class="response-button block w-full text-left bg-green-100 hover:bg-green-200 border border-green-500/50 text-green-800 text-sm py-1.5 px-3 rounded-lg transition-all font-medium">${buttonText}</button>`;
                    });

                    const buttonsHtml = buttons.length > 0 ? '<div class="mt-2 space-y-1">' + buttons.map(btn => `<button class="response-button block w-full text-left bg-green-100 hover:bg-green-200 border border-green-500/50 text-green-800 text-sm py-1.5 px-3 rounded-lg transition-all font-medium" onclick="window.handleUserButtonClick('${btn}')">${btn}</button>`).join('') + '</div>' : '';
                    
                    content = `<div class="w-8 h-8 rounded-full bg-white border-2 border-yellow-400 flex items-center justify-center flex-shrink-0 p-1"><img src="assets/images/poli.png" alt="Bot Icon" class="h-full w-full object-contain"></div><div class="bg-gray-100 p-3 rounded-lg max-w-sm text-gray-800 leading-tight">${formattedText}${buttonsHtml}</div>`;
                    if (isAutoReadEnabled) setTimeout(() => speakText(content.replace(/<[^>]*>?/gm, '')), 300); // Strip HTML for speech
                }
                messageDiv.innerHTML = content;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            window.handleUserButtonClick = (text) => {
                 document.getElementById('user-input').value = text;
                 handleMessage();
            }

            // FUNCIÓN MEJORADA PARA BUSCAR COINCIDENCIAS EXACTAS
            function findExactMatch(userText, allRules) {
                const normalizedUserText = userText.toLowerCase().trim();
                
                // 1. Buscar coincidencia exacta primero
                for (const rule of allRules) {
                    if (rule && rule.keywords) {
                        for (const keyword of rule.keywords) {
                            const normalizedKeyword = keyword.replace(/\*/g, '').toLowerCase().trim();
                            
                            // Coincidencia exacta
                            if (normalizedUserText === normalizedKeyword) {
                                console.log(`🎯 Coincidencia EXACTA encontrada: "${normalizedUserText}" === "${normalizedKeyword}"`);
                                return rule.response;
                            }
                        }
                    }
                }
                
                // 2. Si no hay coincidencia exacta, buscar por inclusión (solo para frases más largas)
                if (normalizedUserText.length > 5) {
                    for (const rule of allRules) {
                        if (rule && rule.keywords) {
                            for (const keyword of rule.keywords) {
                                const normalizedKeyword = keyword.replace(/\*/g, '').toLowerCase().trim();
                                
                                // Solo buscar inclusión si la palabra clave tiene más de 3 caracteres
                                if (normalizedUserText.includes(normalizedKeyword)) {
                                    console.log(`🔍 Coincidencia por INCLUSIÓN: "${normalizedUserText}" incluye "${normalizedKeyword}"`);
                                    return rule.response;
                                }
                            }
                        }
                    }
                }
                
                return null;
            }

            async function handleMessage() {
                const input = document.getElementById('user-input');
                const text = input.value.trim();
                
                if (!text) return;
                
                addMessage('user', text);
                input.value = '';
                
                // Usar la nueva función de búsqueda mejorada
                const response = findExactMatch(text, allRules);
                
                // Si se encuentra una respuesta en las reglas, mostrarla
                if (response) {
                    setTimeout(() => addMessage('bot', response), 500);
                    return; // Termina la ejecución aquí
                }

                // Si NO se encuentra respuesta, consultar a la IA
                addTypingIndicator();
                try {
                    // Combinar el prompt del sistema con la pregunta del usuario
                    const geminiPayload = {
                        contents: [{ parts: [{ text: text }] }], // Use only user text for the prompt
                        safetySettings: [
                            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                            { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                            { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                        ],
                    };

                    const apiResponse = await fetch('/.netlify/functions/gemini-proxy', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(geminiPayload),
                    });

                    removeTypingIndicator();

                    if (!apiResponse.ok) {
                        const errorData = await apiResponse.json();
                        console.error("Error desde el proxy:", errorData);
                        throw new Error(`Error del servidor: ${apiResponse.status}`);
                    }

                    const data = await apiResponse.json();
                    
                    const aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || "No pude obtener una respuesta del asistente inteligente.";
                    addMessage('bot', aiResponse);

                } catch (error) {
                    console.error("Error al contactar al asistente de IA:", error);
                    removeTypingIndicator();
                    addMessage('bot', "Hubo un problema de conexión con el asistente inteligente. Por favor, intenta de nuevo más tarde.");
                }
            }
            
            function addTypingIndicator() {
                const chatMessages = document.getElementById('chat-messages');
                const typingDiv = document.createElement('div');
                typingDiv.id = 'typing-indicator';
                typingDiv.className = 'flex items-start space-x-2 mb-3';
                typingDiv.innerHTML = `<div class="w-8 h-8 rounded-full bg-white border-2 border-yellow-400 flex items-center justify-center flex-shrink-0 p-1"><img src="assets/images/poli.png" alt="Bot Icon" class="h-full w-full object-contain"></div><div class="bg-gray-100 p-3 rounded-lg"><div class="typing-indicator"><span></span><span></span><span></span></div></div>`;
                chatMessages.appendChild(typingDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function removeTypingIndicator() {
                const indicator = document.getElementById('typing-indicator');
                if (indicator) indicator.remove();
            }

            function startVoiceInput() {
                if (!recognition) return;
                const voiceBtn = document.getElementById('voice-btn');
                if (isListening) {
                    recognition.stop();
                    return;
                }
                isListening = true;
                voiceBtn.classList.add('animate-pulse');
                recognition.start();
                recognition.onresult = (event) => {
                    document.getElementById('user-input').value = event.results[0][0].transcript;
                    handleMessage();
                };
                recognition.onerror = (event) => console.error("Error en reconocimiento de voz:", event.error);
                recognition.onend = () => {
                    isListening = false;
                    voiceBtn.classList.remove('animate-pulse');
                };
            }

            function readLastMessage() {
                const messages = document.querySelectorAll('#chat-messages .text-gray-800');
                if (messages.length > 0) {
                    // Get the last message's content, stripping any HTML for speech
                    const lastMessageElement = messages[messages.length - 1];
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = lastMessageElement.innerHTML; // Get HTML content
                    const textToSpeak = tempDiv.innerText; // Get plain text
                    speakText(textToSpeak);
                }
            }
            
            // --- Asignación de Eventos del Chatbot ---
            document.getElementById('chat-toggle-button').addEventListener('click', toggleChat);
            document.getElementById('chat-close-btn-internal').addEventListener('click', toggleChat);
            document.getElementById('chat-backdrop').addEventListener('click', toggleChat);
            document.getElementById('send-button').addEventListener('click', handleMessage);
            document.getElementById('user-input').addEventListener('keypress', e => e.key === 'Enter' && handleMessage());
            
            const toggleSpeakBtn = document.getElementById('toggle-speak-btn');
            const speakerOnIcon = document.getElementById('speaker-on-icon');
            const speakerOffIcon = document.getElementById('speaker-off-icon');

            toggleSpeakBtn.addEventListener('click', () => {
                isAutoReadEnabled = !isAutoReadEnabled;
                speakerOnIcon.classList.toggle('hidden', !isAutoReadEnabled);
                speakerOffIcon.classList.toggle('hidden', isAutoReadEnabled);
                toggleSpeakBtn.classList.toggle('bg-yellow-500', isAutoReadEnabled);
                toggleSpeakBtn.classList.toggle('hover:bg-yellow-600', isAutoReadEnabled);
                toggleSpeakBtn.classList.toggle('bg-gray-500', !isAutoReadEnabled);
                toggleSpeakBtn.classList.toggle('hover:bg-gray-600', !isAutoReadEnabled);
                if (!isAutoReadEnabled) speechSynth.cancel();
            });

            if (recognition) document.getElementById('voice-btn').addEventListener('click', startVoiceInput);
            document.getElementById('speak-btn').addEventListener('click', readLastMessage);
            document.addEventListener('keydown', e => { if (e.altKey && e.key === 'v') { e.preventDefault(); startVoiceInput(); } });

            // --- Verificación de carga de reglas y mensaje de bienvenida ---
            if(allRules.length === 0) {
                console.error("¡Advertencia! No se pudieron cargar las reglas desde 'rules/chatbot-rules.js'. El bot funcionará en modo 'solo IA'.");
            }

            // El bot siempre dará la bienvenida.
            setTimeout(() => {
                const welcomeButtons = ['Menú OS10','Otro Menú','Valores', 'Horario', 'Directiva'];
                addMessage('bot', '¡Hola! Soy tu asistente virtual de la oficina OS10 Coquimbo. ¿En qué puedo ayudarte hoy?', welcomeButtons);
            }, 1000);


            // --- Lógica de Carga Dinámica de Contenido ---
            const dynamicContentArea = document.getElementById('dynamic-content-area');
            let currentPage = 'home'; // Estado para saber qué página estamos mostrando

            // Función para cargar contenido HTML en el área dinámica
            async function loadContent(url) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const html = await response.text();
                    dynamicContentArea.innerHTML = html;
                    
                    // Re-adjuntar eventos después de cargar el nuevo contenido
                    attachDynamicEventListeners();
                    // El contador de visitas principal ya se actualiza una vez al inicio.
                    // No es necesario llamar a window.runCounter() aquí a menos que el contador
                    // deba cambiar con cada vista de contenido, lo cual no es el caso para el banner principal.

                    // Desplazarse al inicio de la página para la nueva vista
                    window.scrollTo({ top: 0, behavior: 'smooth' });

                } catch (error) {
                    console.error(`Error al cargar el contenido de ${url}:`, error);
                    dynamicContentArea.innerHTML = `<p class='text-red-500'>Error al cargar el contenido de ${url}. Por favor, intenta de nuevo.</p>`;
                }
            }

            // Función para adjuntar/re-adjuntar event listeners a elementos cargados dinámicamente
            function attachDynamicEventListeners() {
                // Adjuntar el evento al botón 'Tramitar Credenciales' si está en la vista actual
                const tramitarCredencialesBtn = dynamicContentArea.querySelector('#tramitarCredencialesBtn');
                if (tramitarCredencialesBtn) {
                    tramitarCredencialesBtn.addEventListener('click', () => {
                        loadContent('credenciales.html');
                        currentPage = 'credenciales';
                    });
                }

                // Adjuntar el evento al botón 'Volver' en la página de credenciales si está en la vista actual
                const backButtonFromCredenciales = dynamicContentArea.querySelector('#back-button-from-credenciales');
                if (backButtonFromCredenciales) {
                    backButtonFromCredenciales.addEventListener('click', () => {
                        loadContent('index_home_content.html');
                        currentPage = 'home';
                    });
                }
            }

            // Cargar el contenido de la página principal al inicio
            loadContent('index_home_content.html');

            // Escuchar eventos de navegación (por si hay alguna necesidad externa de cambiar de página)
            window.addEventListener('navigateToHome', () => {
                loadContent('index_home_content.html');
                currentPage = 'home';
            });
            window.addEventListener('navigateToCredenciales', () => {
                loadContent('credenciales.html');
                currentPage = 'credenciales';
            });
        });
    </script>
</body>
</html>
